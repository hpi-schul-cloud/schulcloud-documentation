<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-services/moin-punkt-schule/concept" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Moin.Schule | Schulcloud-Verbund-Software Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://documentation.dbildungscloud.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://documentation.dbildungscloud.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://documentation.dbildungscloud.dev/docs/services/moin-punkt-schule/concept"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Moin.Schule | Schulcloud-Verbund-Software Documentation"><meta data-rh="true" name="description" content="Schulconnex"><meta data-rh="true" property="og:description" content="Schulconnex"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://documentation.dbildungscloud.dev/docs/services/moin-punkt-schule/concept"><link data-rh="true" rel="alternate" href="https://documentation.dbildungscloud.dev/docs/services/moin-punkt-schule/concept" hreflang="en"><link data-rh="true" rel="alternate" href="https://documentation.dbildungscloud.dev/docs/services/moin-punkt-schule/concept" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Services","item":"https://documentation.dbildungscloud.dev/docs/category/services"},{"@type":"ListItem","position":2,"name":"Moin.Schule","item":"https://documentation.dbildungscloud.dev/docs/services/moin-punkt-schule/concept"}]}</script><link rel="stylesheet" href="/assets/css/styles.021e6142.css">
<script src="/assets/js/runtime~main.64d55715.js" defer="defer"></script>
<script src="/assets/js/main.7be193f2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Schulcloud-Verbund-Software</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hpi-schul-cloud/hpi-schul-cloud" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro"><span title="Schulcloud Documentation" class="linkLabel_WmDU">Schulcloud Documentation</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/backend"><span title="Backend" class="categoryLinkLabel_W154">Backend</span></a><button aria-label="Expand sidebar category &#x27;Backend&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/frontend"><span title="Frontend" class="categoryLinkLabel_W154">Frontend</span></a><button aria-label="Expand sidebar category &#x27;Frontend&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/end-to-end-system-tests"><span title="End-to-end System Tests" class="categoryLinkLabel_W154">End-to-end System Tests</span></a><button aria-label="Expand sidebar category &#x27;End-to-end System Tests&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs/category/services"><span title="Services" class="categoryLinkLabel_W154">Services</span></a><button aria-label="Collapse sidebar category &#x27;Services&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/bigbluebutton"><span title="BigBlueButton" class="categoryLinkLabel_W154">BigBlueButton</span></a><button aria-label="Expand sidebar category &#x27;BigBlueButton&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/services/collabora/How it works"><span title="Collabora" class="categoryLinkLabel_W154">Collabora</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/etherpad"><span title="Etherpad" class="categoryLinkLabel_W154">Etherpad</span></a><button aria-label="Expand sidebar category &#x27;Etherpad&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/files-storage"><span title="Files Storage" class="categoryLinkLabel_W154">Files Storage</span></a><button aria-label="Expand sidebar category &#x27;Files Storage&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/h5p"><span title="H5P" class="categoryLinkLabel_W154">H5P</span></a><button aria-label="Expand sidebar category &#x27;H5P&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/nuxt-client"><span title="Nuxt Client" class="categoryLinkLabel_W154">Nuxt Client</span></a><button aria-label="Expand sidebar category &#x27;Nuxt Client&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/oauth"><span title="OAuth" class="categoryLinkLabel_W154">OAuth</span></a><button aria-label="Expand sidebar category &#x27;OAuth&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/schulcloud-client"><span title="Schulcloud Client" class="categoryLinkLabel_W154">Schulcloud Client</span></a><button aria-label="Expand sidebar category &#x27;Schulcloud Client&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/schulcloud-server"><span title="Schulcloud Server" class="categoryLinkLabel_W154">Schulcloud Server</span></a><button aria-label="Expand sidebar category &#x27;Schulcloud Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/tldraw-server"><span title="Tldraw Server" class="categoryLinkLabel_W154">Tldraw Server</span></a><button aria-label="Expand sidebar category &#x27;Tldraw Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/tools"><span title="Tools" class="categoryLinkLabel_W154">Tools</span></a><button aria-label="Expand sidebar category &#x27;Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/category/tsp-synchronisation"><span title="TSP Synchronisation" class="categoryLinkLabel_W154">TSP Synchronisation</span></a><button aria-label="Expand sidebar category &#x27;TSP Synchronisation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/services/moin-punkt-schule/Getting started"><span title="moin-punkt-schule" class="categoryLinkLabel_W154">moin-punkt-schule</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/services/moin-punkt-schule/Getting started"><span title="Getting started Moin.Schule" class="linkLabel_WmDU">Getting started Moin.Schule</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/services/moin-punkt-schule/concept"><span title="Moin.Schule" class="linkLabel_WmDU">Moin.Schule</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/services/provining/concept"><span title="provining" class="categoryLinkLabel_W154">provining</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/how-to-update-the-docs"><span title="How to update the docs" class="categoryLinkLabel_W154">How to update the docs</span></a><button aria-label="Expand sidebar category &#x27;How to update the docs&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Getting started"><span title="Getting started" class="linkLabel_WmDU">Getting started</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/services"><span>Services</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">moin-punkt-schule</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Moin.Schule</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Moin.Schule</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="schulconnex">Schulconnex<a href="#schulconnex" class="hash-link" aria-label="Direct link to Schulconnex" title="Direct link to Schulconnex" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-schulconnex">What is Schulconnex?<a href="#what-is-schulconnex" class="hash-link" aria-label="Direct link to What is Schulconnex?" title="Direct link to What is Schulconnex?" translate="no">​</a></h3>
<p>Schulconnex is an interface (API) for the synchronization of identities and school context data.
Contextual data includes roles, group memberships, subjects, a school number, or information about educational programs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="moinschule-and-schulconnex">moin.schule and Schulconnex<a href="#moinschule-and-schulconnex" class="hash-link" aria-label="Direct link to moin.schule and Schulconnex" title="Direct link to moin.schule and Schulconnex" translate="no">​</a></h2>
<p>moin.schule implements Schulconnex. SVS communicates with moin.schule via Schulconnex.</p>
<p>SVS calls the following Schulconnex-endpoints:</p>
<ul>
<li>person-info</li>
<li>policies-info</li>
</ul>
<p>Latest working version</p>
<p>For Schulconnex documentation see: <a href="https://schulconnex.github.io/Schulconnex/" target="_blank" rel="noopener noreferrer">https://schulconnex.github.io/Schulconnex/</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="backchannel-logout-from-svs-to-moinschule">Backchannel Logout from SVS to moin.schule<a href="#backchannel-logout-from-svs-to-moinschule" class="hash-link" aria-label="Direct link to Backchannel Logout from SVS to moin.schule" title="Direct link to Backchannel Logout from SVS to moin.schule" translate="no">​</a></h2>
<p>Whenever a user logs out of the SVS we want to log the user also out of moin.schule as well. This can be done by sending the session token from moin.schule to their Keycloak when we process the users logout from SVS.</p>
<p>To achieve this we need to port some code and expand on it:</p>
<ul>
<li>Move the Logout Endpoint to NestJs</li>
<li>Save the refresh token from moin.schule</li>
<li>Keep the refresh token alive</li>
<li>Send the refresh token to Keycloak for logout</li>
</ul>
<p>Lets go over them all one-by-one</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="migrate-the-logout-to-nestjs">Migrate the Logout to NestJs<a href="#migrate-the-logout-to-nestjs" class="hash-link" aria-label="Direct link to Migrate the Logout to NestJs" title="Direct link to Migrate the Logout to NestJs" translate="no">​</a></h3>
<p>Logout is currently handled by the legacy server. We need to migrate the mechanism to NestJs. SVS logout works by unlisting the users JWT from the whitelist and clearing the cookie. The cookie clearing is done by the client, however the server deletes the JWT from the whitelist. The code to migrate is located <a href="https://github.com/hpi-schul-cloud/schulcloud-server/blob/622e80eda2e64cde84530527fbd71aacb571431f/src/services/authentication/hooks/index.js#L150" target="_blank" rel="noopener noreferrer">here</a>. The linked hook is executed the route DELETE /api/v1/authentication. Thus we should create a similar endpoint in the authentication module. We already have all necessary infrastructure to access Redis in NestJs inside the CacheModule.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="save-the-refresh-token-from-moinschule">Save the refresh token from moin.schule<a href="#save-the-refresh-token-from-moinschule" class="hash-link" aria-label="Direct link to Save the refresh token from moin.schule" title="Direct link to Save the refresh token from moin.schule" translate="no">​</a></h3>
<p>When we call the token endpoint from moin.schule, we already receive the needed refresh token. This token just needs to be saved for the session in the server. We can use the current CacheWrapperModule to access Redis (Later this will be MongoDB, DevOps would appreciate this more, but this is very likely out-of-scope) and save the token there, similar to the SVS-JWT in the whitelist. The token itself has only a limited TTL, which is saved inside the token itself. I would argue that the token itself is saved with the token for easier access:</p>
<table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>{userId}:{systemId}:refreshtoken</code></td><td><code>{ token: {moin.schule refreshtoken}, ttl:{refreshtoken.ttl} }</code></td></tr></tbody></table>
<p>To keep the session store clean, we should give the entry a reasonable TTL</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="keep-the-refresh-token-alive">Keep the refresh token alive<a href="#keep-the-refresh-token-alive" class="hash-link" aria-label="Direct link to Keep the refresh token alive" title="Direct link to Keep the refresh token alive" translate="no">​</a></h3>
<p>The biggest challenge is to keep the token alive without overwhelming the system. A refresh token has only a limited lifetime and this needs to be updated regularly. As a first attempt we want to update the token whenever the user is authenticated against the SVS. The JWT Guard we are using can also be used to check on such information. A possible entry point for this is <a href="https://github.com/hpi-schul-cloud/schulcloud-server/blob/f454a653ada922422914bcaf6b341e08f26b3051/apps/server/src/modules/authentication/strategy/jwt.strategy.ts#L12" target="_blank" rel="noopener noreferrer">https://github.com/hpi-schul-cloud/schulcloud-server/blob/f454a653ada922422914bcaf6b341e08f26b3051/apps/server/src/modules/authentication/strategy/jwt.strategy.ts#L12</a>, which checks the JWT.</p>
<p>The necessary steps to expand it are:</p>
<ul>
<li>Create a Service for checking the refresh_token<!-- -->
<ul>
<li>This Service checks if the user is an external/moin.schule user</li>
<li>If it is, then check if a refresh_token is available</li>
<li>If the token has a TTL shorter than a specified time (probable through a global setting or ENV-VAR), then trigger a refresh</li>
</ul>
</li>
<li>Call to the external system to update the refresh_token<!-- -->
<ul>
<li>Use the already saved token endpoint in the OauthConfig of the system</li>
<li>The required call is as follows:</li>
</ul>
</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Method: POST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">URL: &lt;token-endpoint&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Body type: x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Form fields:    </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">client_id : &lt;my-client-name&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">grant_type : refresh_token</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">refresh_token: &lt;my-refresh-token&gt;</span><br></span></code></pre></div></div>
<p>The response is a complete new set of tokens though, we only save the refresh token though, as we have currently no use for the other tokens. The new token and TTL are saved in the store as mentioned in the section above.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="send-the-refresh-token-to-keycloak-for-logout">Send the refresh token to Keycloak for logout<a href="#send-the-refresh-token-to-keycloak-for-logout" class="hash-link" aria-label="Direct link to Send the refresh token to Keycloak for logout" title="Direct link to Send the refresh token to Keycloak for logout" translate="no">​</a></h3>
<p>Finally, to facilitate the logout we need to send the refresh token to the Keycloak. It requires the SVS to send the token to the dedicated logout endpoint of the provider. We should already save that endpoint inside our OAuthConfig for the provider.</p>
<p>To log the user out of the Keycloak system we send a request similar to this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Method: POST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">URL: &lt;logout-endpoint&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Header:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	Auth:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		username: &lt;clientId&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		password: &lt;clientSecret&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Body type: x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Form fields:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">refresh_token: &lt;my-refresh-token&gt;</span><br></span></code></pre></div></div>
<p>Possible return values:</p>
<ul>
<li>204 if successful</li>
<li>400 with a detailed JSON message if not</li>
</ul>
<p>The response should not concern our functionality of the SVS logout. It is to be determined if the response matters to us, but for now we can reject it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="refresh-the-refresh-token">Refresh the refresh token<a href="#refresh-the-refresh-token" class="hash-link" aria-label="Direct link to Refresh the refresh token" title="Direct link to Refresh the refresh token" translate="no">​</a></h2>
<blockquote>
<p>Not implemented</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logout-from-moinschule-initiated-in-svs">Logout from moin.schule initiated in SVS<a href="#logout-from-moinschule-initiated-in-svs" class="hash-link" aria-label="Direct link to Logout from moin.schule initiated in SVS" title="Direct link to Logout from moin.schule initiated in SVS" translate="no">​</a></h2>
<p>To have a clean logout for the users, we need to log the user out from moin.schule whenever they are logged out from the SVS. This can be achieved using a Keycloak-specific variant of <em>RP-initiated Logout.</em> A common method in the OIDC standard to tell an Identity Provider that a user should be logged out.</p>
<p>Moin.Schule offers the specified end_session_endpoints (Retrieved on 20.03.2024):</p>
<p>Staging: <a href="https://auth.stage.niedersachsen-login.schule/realms/SANIS/protocol/openid-connect/logout" target="_blank" rel="noopener noreferrer">https://auth.stage.niedersachsen-login.schule/realms/SANIS/protocol/openid-connect/logout</a></p>
<p>Prod: <a href="https://auth.moin.schule/realms/moins/protocol/openid-connect/logout" target="_blank" rel="noopener noreferrer">https://auth.moin.schule/realms/moins/protocol/openid-connect/logout</a></p>
<p>We also receive already the session token, however we currently discard it. Thus we have all required data present.</p>
<p>The general flow would be as follows:</p>
<p><img decoding="async" loading="lazy" alt="Logout Flow Diagram" src="/assets/images/MoinSchuleLogout-ea149ead7579b8fa1141828ce17ad447.png" width="300" height="257" class="img_ev3q"></p>
<blockquote>
<p>Required changes to resolve the acceptens criteria.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logout-from-svs-initiated-in-moinschule">Logout from SVS initiated in moin.schule<a href="#logout-from-svs-initiated-in-moinschule" class="hash-link" aria-label="Direct link to Logout from SVS initiated in moin.schule" title="Direct link to Logout from SVS initiated in moin.schule" translate="no">​</a></h2>
<p>Whenever a User logs out of moin.schule, we also want the user to be able to log out of the SVS as well, if they are logged in there through moin.schule. For this there exists the &quot;OP-initiated Logout-Flow&quot; in the OpenId Connect specification. moin.schule supports this through the underlying Keycloak. SVS on the other hand cannot handle this request yet. We need to integrate this into SVS according to the standard.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow-overview">Flow overview<a href="#flow-overview" class="hash-link" aria-label="Direct link to Flow overview" title="Direct link to Flow overview" translate="no">​</a></h3>
<ol>
<li>The User logs out of moin.schule</li>
<li>moin.schule sends a Logout-JWT to all connected Clients, including SVS</li>
<li>SVS verifies the Logout-JWT</li>
<li>SVS logs the user out and returns OK to moin.schule</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="graphical-flow">Graphical Flow<a href="#graphical-flow" class="hash-link" aria-label="Direct link to Graphical Flow" title="Direct link to Graphical Flow" translate="no">​</a></h4>
<p><img decoding="async" loading="lazy" alt="OIDC Logout Flow Diagram" src="/assets/images/LogoutFromSVSByMoinSchule.drawio-090932aa4f661d86d5e401c50b007d33.svg" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation-steps">Validation Steps<a href="#validation-steps" class="hash-link" aria-label="Direct link to Validation Steps" title="Direct link to Validation Steps" translate="no">​</a></h3>
<p>According to the OIDC Standard, these are the steps required to validate the Logout-JWT:</p>
<ol>
<li>If the Logout Token is encrypted, decrypt it using the keys and algorithms that the Client specified during Registration that the OP was to use to encrypt ID Tokens. If ID Token encryption was negotiated with the OP at Registration time and the Logout Token is not encrypted, the RP SHOULD reject it.</li>
<li>Validate the Logout Token signature in the same way that an ID Token signature is validated, with the following refinements.</li>
<li>Validate the <code>alg</code> (algorithm) Header Parameter in the same way it is validated for ID Tokens. Like ID Tokens, selection of the algorithm used is governed by the <code>id_token_signing_alg_values_supported</code> Discovery parameter and the <code>id_token_signed_response_alg</code> Registration parameter when they are used; otherwise, the value SHOULD be the default of <code>RS256</code>. Additionally, an <code>alg</code> with the value <code>none</code> MUST NOT be used for Logout Tokens.</li>
<li>Validate the <code>iss</code>, <code>aud</code>, <code>iat</code>, and <code>exp</code> Claims in the same way they are validated in ID Tokens.</li>
<li>Verify that the Logout Token contains a <code>sub</code> Claim, a <code>sid</code> Claim, or both.</li>
<li>Verify that the Logout Token contains an <code>events</code> Claim whose value is JSON object containing the member name <a href="http://schemas.openid.net/event/backchannel-logout" target="_blank" rel="noopener noreferrer">http://schemas.openid.net/event/backchannel-logout</a>.</li>
<li>Verify that the Logout Token does not contain a <code>nonce</code> Claim.</li>
</ol>
<p>We can already do all these points, except for 3 and 4. We do not save these information for the login of the user. We can implement these at a later point, since the other points should give us enough security to log out the user reliably.</p>
<p>Points 1 and 2 are already handled by the ID Token validation we implemented. we can reuse it verbatim. 5-7 are simply checking for claims in the JWT and can be easily implemented.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint-design">Endpoint Design<a href="#endpoint-design" class="hash-link" aria-label="Direct link to Endpoint Design" title="Direct link to Endpoint Design" translate="no">​</a></h3>
<p>Finally we need to create a new logout endpoint, more precisely an OIDC logout endpoint. This Endpoint needs to be a public POST route with no Authentication that expects exactly one parameter, the logout token. The Endpoint, according to official documentation, should look like this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">POST /backchannel_logout HTTP/1.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Host: rp.example.org</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">logout_token=eyJhbGci ... .eyJpc3Mi ... .T3BlbklE ...</span><br></span></code></pre></div></div>
<p>We need to decide where to put this Endpoint. my suggestion would be to place it in the Authentication module in a new controller especially for logouts. I suggest <strong>/api/v3/logout/oidc</strong> and in general create a fitting controller for future logout methods (such as the local logout)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/services/moin-punkt-schule/concept.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/services/moin-punkt-schule/Getting started"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Getting started Moin.Schule</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/services/provining/concept"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Concept Provisioning</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#schulconnex" class="table-of-contents__link toc-highlight">Schulconnex</a><ul><li><a href="#what-is-schulconnex" class="table-of-contents__link toc-highlight">What is Schulconnex?</a></li></ul></li><li><a href="#moinschule-and-schulconnex" class="table-of-contents__link toc-highlight">moin.schule and Schulconnex</a></li><li><a href="#backchannel-logout-from-svs-to-moinschule" class="table-of-contents__link toc-highlight">Backchannel Logout from SVS to moin.schule</a><ul><li><a href="#migrate-the-logout-to-nestjs" class="table-of-contents__link toc-highlight">Migrate the Logout to NestJs</a></li><li><a href="#save-the-refresh-token-from-moinschule" class="table-of-contents__link toc-highlight">Save the refresh token from moin.schule</a></li><li><a href="#keep-the-refresh-token-alive" class="table-of-contents__link toc-highlight">Keep the refresh token alive</a></li><li><a href="#send-the-refresh-token-to-keycloak-for-logout" class="table-of-contents__link toc-highlight">Send the refresh token to Keycloak for logout</a></li></ul></li><li><a href="#refresh-the-refresh-token" class="table-of-contents__link toc-highlight">Refresh the refresh token</a></li><li><a href="#logout-from-moinschule-initiated-in-svs" class="table-of-contents__link toc-highlight">Logout from moin.schule initiated in SVS</a></li><li><a href="#logout-from-svs-initiated-in-moinschule" class="table-of-contents__link toc-highlight">Logout from SVS initiated in moin.schule</a><ul><li><a href="#flow-overview" class="table-of-contents__link toc-highlight">Flow overview</a></li><li><a href="#validation-steps" class="table-of-contents__link toc-highlight">Validation Steps</a></li><li><a href="#endpoint-design" class="table-of-contents__link toc-highlight">Endpoint Design</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/schulcloud-server" target="_blank" rel="noopener noreferrer" class="footer__link-item">schulcloud-server<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/nuxt-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">nuxt-client<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/schulcloud-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">schulcloud-client<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/tldraw-server" target="_blank" rel="noopener noreferrer" class="footer__link-item">tldraw-server<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/end-to-end-tests" target="_blank" rel="noopener noreferrer" class="footer__link-item">end-to-end-tests<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>