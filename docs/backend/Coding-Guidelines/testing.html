<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-backend/Coding-Guidelines/testing" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Testing | Schulcloud-Verbund-Software Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://documentation.dbildungscloud.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://documentation.dbildungscloud.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://documentation.dbildungscloud.dev/docs/backend/Coding-Guidelines/testing"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Testing | Schulcloud-Verbund-Software Documentation"><meta data-rh="true" name="description" content="Automated testing is the essential part of the software development process."><meta data-rh="true" property="og:description" content="Automated testing is the essential part of the software development process."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://documentation.dbildungscloud.dev/docs/backend/Coding-Guidelines/testing"><link data-rh="true" rel="alternate" href="https://documentation.dbildungscloud.dev/docs/backend/Coding-Guidelines/testing" hreflang="en"><link data-rh="true" rel="alternate" href="https://documentation.dbildungscloud.dev/docs/backend/Coding-Guidelines/testing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bcdaadb3.css">
<link rel="preload" href="/assets/js/runtime~main.0ace75c2.js" as="script">
<link rel="preload" href="/assets/js/main.79b085ac.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Schulcloud-Verbund-Software</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hpi-schul-cloud/hpi-schul-cloud" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Schulcloud Documentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/backend">Backend</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backend&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Api">API design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/backend/Coding-Guidelines/access-legacy-code">Coding-Guidelines</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/access-legacy-code">Access legacy Code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/code-style">Code Style</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/controllers">Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/deprection-workflow">Deprecation Workflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/domain-object-validation">Domain Object Validation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/event-handling">Event Handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/exception-handling">Exception Handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/logging">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/micro-orm">Defining Entities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/modules-submodules">Implementation and usage of modules, submodule and barrel files in our project</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/repositories">Repositories</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/backend/Coding-Guidelines/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Coding-Guidelines/using-mikroservice-apis">Using the API of a Mikroservice</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Configuration">Configuration state and flows</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/backend/Development/git">Development</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/Migrations">Migrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/architecture">Software Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/detect-dependency-cycles">Detect Dependency Cycles</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/frontend">Frontend</a><button aria-label="Toggle the collapsible sidebar category &#x27;Frontend&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/end-to-end-system-tests">End-to-end System Tests</a><button aria-label="Toggle the collapsible sidebar category &#x27;End-to-end System Tests&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/services">Services</a><button aria-label="Toggle the collapsible sidebar category &#x27;Services&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/how-to-update-the-docs">How to update the docs</a><button aria-label="Toggle the collapsible sidebar category &#x27;How to update the docs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/backend"><span itemprop="name">Backend</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Coding-Guidelines</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Testing</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Testing</h1><p>Automated testing is the essential part of the software development process.
It improves the code quality and ensure that the code operates correctly especially after refactoring.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-test-conventions">General Test Conventions<a href="#general-test-conventions" class="hash-link" aria-label="Direct link to General Test Conventions" title="Direct link to General Test Conventions">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lean-tests">Lean Tests<a href="#lean-tests" class="hash-link" aria-label="Direct link to Lean Tests" title="Direct link to Lean Tests">​</a></h3><p>The tests should be as simple to read and understand as possible. They should be effortless to write and change, in order to not slow down development. Wherever possible:</p><ul><li>avoid complex logic</li><li>cover only one case per test</li><li>only use clearly named and widely used helper functions</li><li>stick to blackbox testing: think about the unit from the outside, not its inner workings.</li><li>its okay to duplicate code for each test</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="naming-convention">Naming Convention<a href="#naming-convention" class="hash-link" aria-label="Direct link to Naming Convention" title="Direct link to Naming Convention">​</a></h3><p>When a test fails, the name of the test is the first hint to the developer (or any other person) to what went wrong where. (along with the &quot;describe&quot; blocks the test is in).
Thus, your describe structure and testcase names should be designed to enable a person unfamiliar with the code to identify the problem as fast as possible. It should tell him:</p><ul><li>what component is being tested</li><li>under what condition</li><li>the expected outcome</li></ul><p>To facilitate this, your tests should be wrapped in at least two describe levels.</p><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Name of the unit under test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe(&quot;Course Service&quot;, (() =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // method that is called</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    describe(&#x27;createCourse&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // a &quot;when...&quot; sentence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        describe(&quot;When a student tries to create a course&quot;, (() =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const setup = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // testsetup for the situation that was described</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // a &quot;should...&quot; sentence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            it(&quot;should return course&quot;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="isolation">Isolation<a href="#isolation" class="hash-link" aria-label="Direct link to Isolation" title="Direct link to Isolation">​</a></h3><p>Each test should be able to run alone, as well as together with any other tests. To ensure this, it is important that the test does not depend on any preexisting data.</p><ul><li>Each test should generate the data it needs, and ensure that its data is deleted afterwards. (this is usually done via mocha&#x27;s &quot;afterEach&quot; function.</li><li>When you create objects with fields that have to be globally unique, like the account username, you must ensure the name you choose is unique. This can be done by including a timestamp.</li><li>Never use seeddata.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-structure">Test Structure<a href="#test-structure" class="hash-link" aria-label="Direct link to Test Structure" title="Direct link to Test Structure">​</a></h3><p>Your test should be structured in three seperate areas, each distinguished by at least an empty line:</p><ul><li>Arrange - set up your testdata</li><li>Act - call the function you want to test</li><li>Assert - check the result</li></ul><p>this is known as the AAA-pattern.</p><p>The tests for a unit should cover as much scenarios as possible. Parameters and the combination of parameters can often take numerous values. Therefore it largely differs from case to case what a sufficient amount of scenarios would be. Parameter values that contradict the typescript type definition should be ignored as a test case.
The test coverage report already enforces scenarios that test every possible if/else result in the code. But still some scenarios are not covered by the report and must be tested:</p><ul><li>All error scenarios: That means one describe block for every call that can reject.</li></ul><p>We use different levels of describe blocks to structure the tests in a way, that the tested scenarios could easily be recognized. The outer describe would be the function call itself. Every scenario is added as another describe inside the outer describe.</p><p>All of the data and mock preparation should happen in a setup function. Every describe scenario only contains one setup function and is called in every test. No further data or mock preparation should be added to the test. Often there will be only one test in every describe scenario, this is perfectly fine with our desired structure.</p><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">describe(&#x27;[method]&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    describe(&#x27;when [senario description that is prepared in setup]&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const setup = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // prepare the data and mocks for this scenario</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it(&#x27;...&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const { } = setup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it(&#x27;...&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const { } = setup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    describe(&#x27;when [senario description that is prepared in setup]&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const setup = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // prepare the data and mocks for this scenario</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it(&#x27;...&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const { } = setup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-samples">Testing Samples<a href="#testing-samples" class="hash-link" aria-label="Direct link to Testing Samples" title="Direct link to Testing Samples">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-of-function-return-values">Handling of function return values<a href="#handling-of-function-return-values" class="hash-link" aria-label="Direct link to Handling of function return values" title="Direct link to Handling of function return values">​</a></h3><p>When assigning a value to an expect, separate the function call from the expectation to simplify debugging. This later helps when you not know about the return value type or if it&#x27;s an promise or not. This is good style not only for tests.</p><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // doSomethingCrazy : retValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;bad sample&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(doSomethingCrazy(x,y,z)).to...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;good sample&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const result = doSomethingCrazy(x,y,z)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(result).to... // here we can simply debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="promises-and-timouts-in-tests">Promises and Timouts in tests<a href="#promises-and-timouts-in-tests" class="hash-link" aria-label="Direct link to Promises and Timouts in tests" title="Direct link to Promises and Timouts in tests">​</a></h3><p>When using asynchronous functions and/opr promises, results must be awaited within of an async test function instead of using promise chains. While for expecting error conditions it might be helpful to use catch for extracting a value from an expected error, in every case avoid writing long promise chains.</p><ul><li>Instead of using done callback, use async test functions.</li><li>Use await instead of (long) promise chains</li><li>never manually set a timeout</li></ul><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // doSomethingCrazy : Promise&lt;retValue&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;bad async sample&#x27;, async function (done) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSomethingCrazy(x,y,z).then(result=&gt;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expect(result).to...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            done() // expected done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }).catch(()=&gt;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(`Could not ... ${error}`);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            done() // unexpected done, test will always succeed which is wrong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 10000 /* timeout in ms */) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;good async sample&#x27;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // no timeout set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const result = await doSomethingCrazy(x,y,z)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(result).to...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Timeouts must not be used, when async handling is correctly defined!</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expecting-errors-in-tests">Expecting errors in tests<a href="#expecting-errors-in-tests" class="hash-link" aria-label="Direct link to Expecting errors in tests" title="Direct link to Expecting errors in tests">​</a></h3><p>When expecting an error, you might take values from an error, test for the error type thrown and must care of promises.</p><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // doSomethingCrazy : Promise&lt;retValue&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;bad async sample expecting an error&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(doSomethingCrazy(x,y,z)).to...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;good async sample expecting an error value&#x27;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const code = await doSomethingCrazy(x,y,z).catch(err =&gt; err.code)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(code).to...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;good sample expecting an error type from a sync function&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect(() =&gt; doSomethingCrazySync(wrong, param)).toThrow(BadRequestException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it(&#x27;good sample expecting an error type from an async function&#x27;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await expect(doSomethingCrazySync(wrong, param)).rejects.toThrow(BadRequestException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-utilities">Testing Utilities<a href="#testing-utilities" class="hash-link" aria-label="Direct link to Testing Utilities" title="Direct link to Testing Utilities">​</a></h2><p>NestJS:</p><ul><li>provides default tooling (such as test runner that builds an isolated module/application loader)</li><li>provides integration with <strong>Jest</strong> and <strong>Supertest</strong> out of the box</li><li>makes the Nest dependency injection system available in the testing environment for mocking components</li></ul><p>The <code>@nestjs/testing.Test</code> class provides an execution context that mocks the full Nest runtime, but gives
hooks that can help to manage class instances, including mocking and overriding.</p><p>The method <code>Test.createTestingModule()</code> takes module metadata as argument it returns <code>TestingModule</code> instance.
The <code>TestingModule</code> instance provides method <code>compile()</code> which bootstraps a module with its dependencies.
Every provider can be overwritten with custom provider implementation for testing purposes.</p><div class="language-Typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  beforeAll(async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      const moduleRef = await Test.createTestingModule({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          controllers: [SampleController],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          providers: [SampleService],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }).compile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sampleService = moduleRef.get&lt;SampleService&gt;(SampleService);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sampleController = moduleRef.get&lt;SampleController&gt;(CatsController);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mocking">Mocking<a href="#mocking" class="hash-link" aria-label="Direct link to Mocking" title="Direct link to Mocking">​</a></h2><p>Using the utilities provided by NestJs, we can easily inject mocks into our testing module. The mocks themselves, we create using a <a href="https://www.npmjs.com/package/@golevelup/ts-jest" target="_blank" rel="noopener noreferrer">library</a> by @golevelup.</p><p>You can create a mock using <code>createMock&lt;Class&gt;()</code>. As result you will recieved a <code>DeepMocked&lt;Class&gt;</code></p><div class="language-Typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let fut: FeatureUnderTest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mockService: DeepMocked&lt;MockService&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">beforeAll(async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const module = await Test.createTestingModule({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        providers: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            FeatureUnderTest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                provide: MockService,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                useValue: createMock&lt;MockService&gt;(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }).compile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fut = module.get(FeatureUnderTest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mockService = module.get(MockService);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">afterAll(async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await module.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">afterEach(() =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jest.resetAllMocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The resulting mock has all the functions of the original <code>Class</code>, replaced with jest spies. This gives you code completion and type safety, combined with all the features of spies.</p><p><code>createTestingModule</code> should only be calld in <code>beforeAll</code> and not in <code>beforeEach</code> to keep the setup and teardown for each test as simple as possible. Therefore <code>module.close</code> should only be called in <code>afterAll</code> and not in <code>afterEach</code>.</p><p>To generally reset specific mock implementation after each test <code>jest.resetAllMocks</code> can be used in afterEach. <code>jest.restoreAllMocks</code> should not be used, because in some cases it will not properly restore mocks created by ts-jest.</p><div class="language-Typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">describe(&#x27;somefunction&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    describe(&#x27;when service returns user&#x27;, () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const setup = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const resultUser = userFactory.buildWithId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mockService.getUser.mockReturnValueOnce(resultUser);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return { resultUser };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it(&#x27;should call service&#x27;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            setup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await fut.somefunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expect(mockService.getUser).toHaveBeenCalled();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it(&#x27;should return user passed by service&#x27;, async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const { resultUser } = setup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            const result = await fut.somefunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expect(result).toEqual(resultUser);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For creating specific mock implementations the helper functions which only mock the implementation once, must be used (e.g. mockReturnValueOnce). With that approach more control over mocked functions can be achieved.</p><p>If you want to mock a method that is not part of a dependency you can mock it with <code>jest.spyOn</code>. We strongly recommend the use of <code>jest.spyOn</code> and not <code>jest.fn</code>, because <code>jest.spyOn</code> can be restored a lot easier.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unit-tests-vs-integration-tests">Unit Tests vs Integration Tests<a href="#unit-tests-vs-integration-tests" class="hash-link" aria-label="Direct link to Unit Tests vs Integration Tests" title="Direct link to Unit Tests vs Integration Tests">​</a></h2><p>In Unit Tests we access directly only the component which is currently testing.
Any dependencies should be mocked or are replaced with default testing implementation.
Especially the database access and database calls should be mocked.</p><p>In contrast to unit tests the integration tests use access to the database and execute
real queries using repositories.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="repo-tests">Repo Tests<a href="#repo-tests" class="hash-link" aria-label="Direct link to Repo Tests" title="Direct link to Repo Tests">​</a></h3><p>For the data access layer, integration tests can be used to check the repositories base functionality against a database.</p><p>For Queries care DRY principle, they should be tested very carefully.</p><blockquote><p>Use a in-memory database for testing to allow parallel test execution and have isolated execution of tests.
A test must define the before and after state of the data set clearly and cleanup the database after execution to the before state.
Instead of using predefined data sets, all preconditions should be defined in code through fixtures.</p></blockquote><p>Our repository layer uses <code>mikro-orm/EntityManager</code> to execute the queries.
By testing repositories we want to verify the correct behaviour of the repository functions.
It includes verifying expected database state after executed repository function.
Therefore, the <code>*.repo.integration.spec.js</code> should be used.</p><p>The basic structure of the repo integration test:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="preconditions-beforeall">Preconditions (beforeAll)<a href="#preconditions-beforeall" class="hash-link" aria-label="Direct link to Preconditions (beforeAll)" title="Direct link to Preconditions (beforeAll)">​</a></h4><ol><li>Create <code>Nest JS testing module</code>:
1.1 with <code>MongoMemoryDatabaseModule</code> defining entities which are used in tests. This will wrap MikroOrmModule.forRoot() with running a MongoDB in memory.
1.2 provide the repo which should be tested</li><li>Get repo, orm and entityManager from testing module</li></ol><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    import { MongoMemoryDatabaseModule } from &#x27;@src/modules/database&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let repo: NewsRepo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let em: EntityManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let testModule: TestingModule;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beforeAll(async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        testModule: TestingModule = await Test.createTestingModule({    (1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             imports: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     MongoMemoryDatabaseModule.forRoot({                 (1.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    entities: [News, CourseNews, ...],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             providers: [NewsRepo],                                     (1.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }).compile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      repo = testModule.get(NewsRepo);                                  (2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      orm = testModule.get(MikroORM);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      em = testModule.get(EntityManager);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="post-conditions-afterall-teardown">Post conditions (afterAll), Teardown<a href="#post-conditions-afterall-teardown" class="hash-link" aria-label="Direct link to Post conditions (afterAll), Teardown" title="Direct link to Post conditions (afterAll), Teardown">​</a></h4><p>After all tests are executed close the app and orm to release the resources by closing the test module.</p><div class="language-TypeScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-TypeScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    afterAll(async () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await testModule.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>When Jest reports open handles that not have been closed, ensure all Promises are awaited and all application parts started are correctly closed.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="entity-factories">Entity Factories<a href="#entity-factories" class="hash-link" aria-label="Direct link to Entity Factories" title="Direct link to Entity Factories">​</a></h4><p>To fill the in-memory-db we use factories. They are located in <code>\apps\server\src\shared\testing\factory</code>. If you create a new one, please add it to the index.ts in that folder.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="accessing-the-in-memory-db">Accessing the in-memory-db<a href="#accessing-the-in-memory-db" class="hash-link" aria-label="Direct link to Accessing the in-memory-db" title="Direct link to Accessing the in-memory-db">​</a></h4><p>While debugging the tests, the URL to the in-memory-db can be found in the <code>EntityManager</code> instance of your repo in <code>em.config.options.clientUrl</code>.</p><p>Copy paste this URL to your DB Tool e.g. MongoDB Compass. You will find a database called &#x27;test&#x27; with the data you created for your test.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mapping-tests">Mapping Tests<a href="#mapping-tests" class="hash-link" aria-label="Direct link to Mapping Tests" title="Direct link to Mapping Tests">​</a></h3><p>Mapping tests are Unit Tests which verify the correct mapping between entities and Dto objects.
These tests should not have any external dependencies to other layers like database or use cases.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-case-tests">Use Case Tests<a href="#use-case-tests" class="hash-link" aria-label="Direct link to Use Case Tests" title="Direct link to Use Case Tests">​</a></h3><p>Since a <a href="/docs/backend/architecture#domain-layer">usecase</a> only contains orchestration, its tests should be decoupled from the components it depends on. We thus use unittests to verify the orchestration where necessary</p><blockquote><p>All Dependencies should be mocked.
Use Spies to verify necessary steps, such as authorisation checks.</p></blockquote><p>to be documented</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="controller-tests">Controller Tests<a href="#controller-tests" class="hash-link" aria-label="Direct link to Controller Tests" title="Direct link to Controller Tests">​</a></h3><p>Controllers do not contain any logic, but exclusively information to map and validate between dataformats used on the network, and those used internally, as well as documentation of the api.</p><p>Most of these things can not be covered by unit tests. Therefore we do not write specific unittests for them, and only cover them with <a href="#api-tests">api tests</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-tests">API Tests<a href="#api-tests" class="hash-link" aria-label="Direct link to API Tests" title="Direct link to API Tests">​</a></h3><p>The API tests are plumbing or integration tests. Their job is to make sure all components that interact to fulfill a specific api endpoint are wired up correctly, and fulfil the expectation set up in the documentation.</p><p>API tests should be located in the folder <em>controller/api-test</em> of each module.</p><p>They should call the endpoint like a external entity would, treating it like a blackbox. It should try all parameters available on the API, users with different roles, as well as relevant error cases.</p><p>During the API test, all components that are part of the server, or controlled by the server, should be available. This includes an in-memory database.</p><p>Any external services or servers that are outside our control should be mocked away via their respective adapters.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><p>This guide is inspired by <a href="https://github.com/goldbergyoni/javascript-testing-best-practices/" target="_blank" rel="noopener noreferrer">javascript-testing-best-practices by goldbergyoni</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/backend/Coding-Guidelines/testing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/backend/Coding-Guidelines/repositories"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Repositories</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/backend/Coding-Guidelines/using-mikroservice-apis"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using the API of a Mikroservice</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#general-test-conventions" class="table-of-contents__link toc-highlight">General Test Conventions</a><ul><li><a href="#lean-tests" class="table-of-contents__link toc-highlight">Lean Tests</a></li><li><a href="#naming-convention" class="table-of-contents__link toc-highlight">Naming Convention</a></li><li><a href="#isolation" class="table-of-contents__link toc-highlight">Isolation</a></li><li><a href="#test-structure" class="table-of-contents__link toc-highlight">Test Structure</a></li></ul></li><li><a href="#testing-samples" class="table-of-contents__link toc-highlight">Testing Samples</a><ul><li><a href="#handling-of-function-return-values" class="table-of-contents__link toc-highlight">Handling of function return values</a></li><li><a href="#promises-and-timouts-in-tests" class="table-of-contents__link toc-highlight">Promises and Timouts in tests</a></li><li><a href="#expecting-errors-in-tests" class="table-of-contents__link toc-highlight">Expecting errors in tests</a></li></ul></li><li><a href="#testing-utilities" class="table-of-contents__link toc-highlight">Testing Utilities</a></li><li><a href="#mocking" class="table-of-contents__link toc-highlight">Mocking</a></li><li><a href="#unit-tests-vs-integration-tests" class="table-of-contents__link toc-highlight">Unit Tests vs Integration Tests</a><ul><li><a href="#repo-tests" class="table-of-contents__link toc-highlight">Repo Tests</a></li><li><a href="#mapping-tests" class="table-of-contents__link toc-highlight">Mapping Tests</a></li><li><a href="#use-case-tests" class="table-of-contents__link toc-highlight">Use Case Tests</a></li><li><a href="#controller-tests" class="table-of-contents__link toc-highlight">Controller Tests</a></li><li><a href="#api-tests" class="table-of-contents__link toc-highlight">API Tests</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/schulcloud-server" target="_blank" rel="noopener noreferrer" class="footer__link-item">schulcloud-server<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/nuxt-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">nuxt-client<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/schulcloud-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">schulcloud-client<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/tldraw-server" target="_blank" rel="noopener noreferrer" class="footer__link-item">tldraw-server<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/hpi-schul-cloud/end-to-end-tests" target="_blank" rel="noopener noreferrer" class="footer__link-item">end-to-end-tests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.0ace75c2.js"></script>
<script src="/assets/js/main.79b085ac.js"></script>
</body>
</html>