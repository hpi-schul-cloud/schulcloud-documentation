"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[3890],{2643:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Use_TLDRAW.drawio-4bf58f72fe892751785ed663d14be774.svg"},2953:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Delete_TLDRAW.drawio-61c2f0c343f6f3a2a851ec2e823b3d10.svg"},3644:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Create_TLDRAW.drawio-02816a6ee0c8980696a02ea0d6ebaeb4.svg"},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>a});var i=n(6540);const t={},r=i.createContext(t);function l(e){const s=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:s},e.children)}},9778:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"topics/tldraw-server/How it works","title":"How it works","description":"The terms Redis and Valkey are used here synonymously and should describe the used in-memory-database.","source":"@site/docs/topics/tldraw-server/How it works.md","sourceDirName":"topics/tldraw-server","slug":"/topics/tldraw-server/How it works","permalink":"/docs/topics/tldraw-server/How it works","draft":false,"unlisted":false,"editUrl":"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/topics/tldraw-server/How it works.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Tldraw Server","permalink":"/docs/category/tldraw-server"},"next":{"title":"Local setup","permalink":"/docs/topics/tldraw-server/Local setup"}}');var t=n(4848),r=n(8453);const l={},a="How it works",d={},o=[{value:"Configuration",id:"configuration",level:2},{value:"Create",id:"create",level:2},{value:"Usage",id:"usage",level:2},{value:"Connection",id:"connection",level:3},{value:"Sending updates/storing data",id:"sending-updatesstoring-data",level:3},{value:"Delete",id:"delete",level:2},{value:"Assets",id:"assets",level:2},{value:"files upload",id:"files-upload",level:3},{value:"files deletion",id:"files-deletion",level:3}];function c(e){const s={a:"a",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"how-it-works",children:"How it works"})}),"\n",(0,t.jsx)(s.p,{children:"The terms Redis and Valkey are used here synonymously and should describe the used in-memory-database."}),"\n",(0,t.jsx)(s.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"AUTHORIZATION_API_HOST - host address of the authorization endpoint (schuldcloud-server)"}),"\n",(0,t.jsx)(s.li,{children:"FEATURE_TLDRAW_ENABLED - flag determining if tldraw is enabled"}),"\n",(0,t.jsx)(s.li,{children:"LOGGER_LOG_LEVEL - logging level"}),"\n",(0,t.jsx)(s.li,{children:"LOGGER_EXIT_ON_ERROR - flag whether an error will cause the application to stop"}),"\n",(0,t.jsx)(s.li,{children:"METRICS_COLLECT_DEFAULT - flag whether the default metrics shall be collected"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_CLUSTER_ENABLED - flag whether a redis cluster or used or not"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_URL - redis connection string"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_SENTINEL_SERVICE_NAME - name of the redis sentinel service"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_PREFIX - prefix to be used with redis database"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_SENTINEL_NAME - name of the redis sentinel"}),"\n",(0,t.jsx)(s.li,{children:"REDIS_SENTINEL_PASSWORD - password for the redis sentinel"}),"\n",(0,t.jsx)(s.li,{children:"S3_ACCESS_KEY - access key for S3 storage"}),"\n",(0,t.jsx)(s.li,{children:"S3_BUCKET - name of the S3 bucket"}),"\n",(0,t.jsx)(s.li,{children:"S3_ENDPOINT - URL of the S3 service"}),"\n",(0,t.jsx)(s.li,{children:"S3_PORT - port number for the S3 service"}),"\n",(0,t.jsx)(s.li,{children:"S3_SECRET_KEY - secret key for S3 storage"}),"\n",(0,t.jsx)(s.li,{children:"S3_SSL - flag to enable or disable SSL for S3 storage"}),"\n",(0,t.jsx)(s.li,{children:"TLDRAW_ASSETS_ENABLED - enables uploading assets to tldraw board"}),"\n",(0,t.jsx)(s.li,{children:"TLDRAW_ASSETS_MAX_SIZE_BYTES - maximum asset size in bytes"}),"\n",(0,t.jsx)(s.li,{children:"TLDRAW_ASSETS_ALLOWED_MIME_TYPES_LIST - list of allowed assets MIME types"}),"\n",(0,t.jsx)(s.li,{children:"TLDRAW_WEBSOCKET_PATH - path for the tldraw websocket connection"}),"\n",(0,t.jsx)(s.li,{children:"TLDRAW_WEBSOCKET_URL - URL for the tldraw websocket connection"}),"\n",(0,t.jsx)(s.li,{children:"WORKER_MIN_MESSAGE_LIFETIME - minimal lifetime of a update message consumed by the worker"}),"\n",(0,t.jsx)(s.li,{children:"WORKER_TASK_DEBOUNCE - minimum idle time (in milliseconds) of the pending task messages to be claimed"}),"\n",(0,t.jsx)(s.li,{children:"WORKER_TRY_CLAIM_COUNT - the maximum number of task messages to claim"}),"\n",(0,t.jsx)(s.li,{children:"X_API_ALLOWED_KEYS - list of allowed xAPI keys"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"In order to have deletion functionality fully working locally you have to fill those feature flags, e.g.:"}),"\n",(0,t.jsx)(s.p,{children:"tldraw-server :"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:'X_API_ALLOWED_KEYS="7ccd4e11-c6f6-48b0-81eb-abcdef123456"'}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"schulcloud-server :"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:'TLDRAW_ADMIN_API_CLIENT_API_KEY="7ccd4e11-c6f6-48b0-81eb-abcdef123456"'}),"\n",(0,t.jsxs)(s.li,{children:['TLDRAW_ADMIN_API_CLIENT_BASE_URL="',(0,t.jsx)(s.a,{href:"http://localhost:3349",children:"http://localhost:3349"}),'"']}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"create",children:"Create"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Create tldraw workflow",src:n(3644).A+"",width:"2344",height:"1940"})}),"\n",(0,t.jsx)(s.p,{children:"The Tldraw board can be created by the user on the courses ColumnBoard. It has a representation in ColumnBoard as DrawingElement inside a card (BoardNode in db). After creating representation as DrawingElement we can enter actual Tldraw SPA client on click."}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"User enters ColumnBoard and creates Representation of whiteboard (tldraw) in Card."}),"\n",(0,t.jsx)(s.li,{children:"Data is saved and feedback with proper creation is given - user can see Representation and can enter whiteboard."}),"\n",(0,t.jsx)(s.li,{children:"By entering whiteboard user is redirected to SPA tldraw-client."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-client is starting WS connection with tldraw-server."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server first checks if user has permission to this resource (by checking if user has a permission to Representation of whiteboard - BoardNode).\nId of Representation is same as drawingName, which is visible in tldraw-client url."}),"\n",(0,t.jsx)(s.li,{children:"If user has permission tldraw-server is allowing to remain connected and getting drawing data from S3 storage. If there is no drawing data available, the tldraw-server will create a new document automatically."}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Usage tldraw workflow",src:n(2643).A+"",width:"4120",height:"2416"})}),"\n",(0,t.jsx)(s.h3,{id:"connection",children:"Connection"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"User joins tldraw board."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-client connects to one of the tldraw-server pods and tries to establish websocket connection."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server calls schulcloud-server via HTTP requests to check user permissions. If everything is fine, the websocket connection is established."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server gets stored tldraw board data from S3 storage and sends it via websocket to connected user."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server starts subscribing to Redis PUBSUB channel corresponding to tldraw board name to listen to changes from other pods."}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"sending-updatesstoring-data",children:"Sending updates/storing data"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"Tldraw-client sends user's drawing changes to the tldraw-server via websocket connection."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server stores the board update in the valkey db - basically creates a diff between what's already stored and what's being updated."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server pushes the update to the boards Redis channel so that connected clients on different pods have synchronized board data."}),"\n",(0,t.jsx)(s.li,{children:"Other pods subscribing to Redis channel send updates to their connected clients via websocket whenever they see a new message on Redis channel."}),"\n",(0,t.jsx)(s.li,{children:"Finally the worker will run and persist the current state of the drawing data by applying all currently available updates from valkey on top of the stored drawing data and update the S3 storage accordingly."}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"delete",children:"Delete"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Delete tldraw workflow",src:n(2953).A+"",width:"2020",height:"1368"})}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"User from schulcloud app in ColumnBoard deletes whiteboard (tldraw) instance form Card."}),"\n",(0,t.jsx)(s.li,{children:"Schulcloud-server is removing representation data in schulcloud-database - BoardNodes collection."}),"\n",(0,t.jsx)(s.li,{children:"Schulcloud-server is calling tldraw-server to delete all data that has given id."}),"\n",(0,t.jsx)(s.li,{children:"Tldraw-server sends a delete action via websocket to inform connected clients about deletion. Clients redirect away from Tldraw-board to ensure that no new messages are added to valkey database."}),"\n",(0,t.jsx)(s.li,{children:"Finally the worker will run, clear all updates and data from the valkey db and delete the drawing data from the S3 storage."}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"assets",children:"Assets"}),"\n",(0,t.jsx)(s.h3,{id:"files-upload",children:"files upload"}),"\n",(0,t.jsx)(s.p,{children:"Images/GIFs can be uploaded into tldraw whiteboard by every user with access to the board. We use SVS FileStorageService to physically store uploaded assets while tldraw only holds URL to a resource."}),"\n",(0,t.jsx)(s.p,{children:"The files are uploaded by calling schulcloud-api's fileController upload endpoint. This is possible because tldraw is represented as a boardnode called drawing-element. Mongo id of this drawing-element is a roomId used in URL param when connecting to a specific board."}),"\n",(0,t.jsx)(s.h3,{id:"files-deletion",children:"files deletion"}),"\n",(0,t.jsx)(s.p,{children:"The deletion of files is handled directly by the tldraw-client itself. On deletion in the UI, the client sends a delete request to the file storage. While awaiting the answer from file storage the editing of the Tldraw-board is blocked to prevent race conditions to the file storage."})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);