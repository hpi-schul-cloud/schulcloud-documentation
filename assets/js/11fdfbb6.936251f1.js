"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[2647],{5360:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"services/h5p/Library management/H5P library management service","title":"H5P library management service","description":"Overview","source":"@site/docs/services/h5p/Library management/H5P library management service.md","sourceDirName":"services/h5p/Library management","slug":"/services/h5p/Library management/H5P library management service","permalink":"/docs/services/h5p/Library management/H5P library management service","draft":false,"unlisted":false,"editUrl":"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/services/h5p/Library management/H5P library management service.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"How it works","permalink":"/docs/services/h5p/How it works"},"next":{"title":"build-h5p-libraries.js","permalink":"/docs/services/h5p/Library management/scripts/build-h5p-libraries"}}');var s=n(4848),l=n(8453);const a={},t="H5P library management service",d={},o=[{value:"Overview",id:"overview",level:2},{value:"Responsibilities",id:"responsibilities",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Main Methods",id:"main-methods",level:2},{value:"<code>run()</code>",id:"run",level:3},{value:"<code>uninstallUnwantedLibrariesAsBulk()</code>",id:"uninstallunwantedlibrariesasbulk",level:3},{value:"<code>installLibrariesAsBulk(availableLibraries)</code>",id:"installlibrariesasbulkavailablelibraries",level:3},{value:"<code>synchronizeDbEntryAndLibraryJson()</code>",id:"synchronizedbentryandlibraryjson",level:3},{value:"<code>checkAndRemoveBrokenLibraries()</code>",id:"checkandremovebrokenlibraries",level:3},{value:"Helper Methods",id:"helper-methods",level:2},{value:"Configuration",id:"configuration-1",level:2},{value:"Library Versioning",id:"library-versioning",level:2},{value:"Error Handling &amp; Logging",id:"error-handling--logging",level:2},{value:"Extensibility",id:"extensibility",level:2},{value:"Usage Example",id:"usage-example",level:2},{value:"Related Files",id:"related-files",level:2},{value:"References",id:"references",level:2}];function c(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"h5p-library-management-service",children:"H5P library management service"})}),"\n",(0,s.jsx)(i.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"H5PLibraryManagementService"})," is a NestJS service responsible for managing H5P libraries in the schulcloud-server application. It automates the installation, synchronization, and removal of H5P libraries based on a configurable wish list, ensuring that only the desired libraries and their latest versions are available in the system."]}),"\n",(0,s.jsx)(i.h2,{id:"responsibilities",children:"Responsibilities"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Install libraries"})," from a configured wish list, always fetching the latest version from H5P Hub."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Uninstall libraries"})," not in the wish list and not required by other libraries."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Synchronize metadata"})," between the database and S3 storage."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Check and remove broken libraries"})," that fail consistency checks."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Log all operations"})," for monitoring and debugging."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["The wish list of libraries is defined in a YAML file, whose path is set via the ",(0,s.jsx)(i.code,{children:"H5P_EDITOR__LIBRARY_LIST_PATH"})," configuration property."]}),"\n",(0,s.jsx)(i.li,{children:"The service reads this file at startup and uses it to determine which libraries should be installed or removed."}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"main-methods",children:"Main Methods"}),"\n",(0,s.jsx)(i.h3,{id:"run",children:(0,s.jsx)(i.code,{children:"run()"})}),"\n",(0,s.jsx)(i.p,{children:"Executes the full library management workflow:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"Logs start."}),"\n",(0,s.jsx)(i.li,{children:"Gets available libraries."}),"\n",(0,s.jsx)(i.li,{children:"Uninstalls unwanted libraries."}),"\n",(0,s.jsx)(i.li,{children:"Installs desired libraries."}),"\n",(0,s.jsx)(i.li,{children:"Synchronizes metadata."}),"\n",(0,s.jsx)(i.li,{children:"Removes broken libraries."}),"\n",(0,s.jsx)(i.li,{children:"Logs finish and metrics."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"uninstallunwantedlibrariesasbulk",children:(0,s.jsx)(i.code,{children:"uninstallUnwantedLibrariesAsBulk()"})}),"\n",(0,s.jsx)(i.p,{children:"Removes libraries not in the wish list and not needed by others, iteratively."}),"\n",(0,s.jsx)(i.h3,{id:"installlibrariesasbulkavailablelibraries",children:(0,s.jsx)(i.code,{children:"installLibrariesAsBulk(availableLibraries)"})}),"\n",(0,s.jsx)(i.p,{children:"Installs all libraries from the wish list, ensuring the latest versions are present."}),"\n",(0,s.jsx)(i.h3,{id:"synchronizedbentryandlibraryjson",children:(0,s.jsx)(i.code,{children:"synchronizeDbEntryAndLibraryJson()"})}),"\n",(0,s.jsx)(i.p,{children:"Ensures metadata in the database matches the library.json in S3, updating or adding as needed."}),"\n",(0,s.jsx)(i.h3,{id:"checkandremovebrokenlibraries",children:(0,s.jsx)(i.code,{children:"checkAndRemoveBrokenLibraries()"})}),"\n",(0,s.jsx)(i.p,{children:"Checks all libraries for consistency and removes any that fail."}),"\n",(0,s.jsx)(i.h2,{id:"helper-methods",children:"Helper Methods"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Consistency Checks"}),": ",(0,s.jsx)(i.code,{children:"checkConsistency"}),", ",(0,s.jsx)(i.code,{children:"jsIsMissing"}),", ",(0,s.jsx)(i.code,{children:"cssIsMissing"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Metadata Filtering"}),": ",(0,s.jsx)(i.code,{children:"filterLibraryMetadata"}),", ",(0,s.jsx)(i.code,{children:"filterInstalledLibrary"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Logging"}),": Methods for logging start, finish, errors, and removals."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Error Handling"}),": Handles timeouts, consistency errors, and missing files."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"configuration-1",children:"Configuration"}),"\n",(0,s.jsxs)(i.p,{children:["Uses values from ",(0,s.jsx)(i.code,{children:"IH5PLibraryManagementConfig"})," for settings like lock times and library list paths."]}),"\n",(0,s.jsx)(i.h2,{id:"library-versioning",children:"Library Versioning"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Library versions are tracked using the format: ",(0,s.jsx)(i.code,{children:"machineName-major.minor.patch"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:["The service ensures only the latest versions are installed and synchronizes metadata of older versions, which were build and uploaded to the S3/Cloud storage using :","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["the ",(0,s.jsxs)(i.a,{href:"/docs/services/h5p/Library%20management/scripts/update-h5p-map",children:[(0,s.jsx)(i.code,{children:"update-h5p-map"})," script"]})," to create a mapping between the machine name of all H5P libraries (e.g. ",(0,s.jsx)(i.code,{children:"H5P.InteractiveVideo"}),") and the name of the respective GitHub repository (e.g. ",(0,s.jsx)(i.code,{children:" h5p/h5p-interactive-video"}),")"]}),"\n",(0,s.jsxs)(i.li,{children:["the ",(0,s.jsxs)(i.a,{href:"/docs/services/h5p/Library%20management/scripts/build-h5p-libraries",children:[(0,s.jsx)(i.code,{children:"build-h5p-libraries"})," script"]})," to download, process and build all latest patch versions of all available major-minor releases, and"]}),"\n",(0,s.jsxs)(i.li,{children:["the ",(0,s.jsxs)(i.a,{href:"./scripts/upload-h5p-libraries",children:[(0,s.jsx)(i.code,{children:"upload-h5p-libraries"})," script"]})," to upload all the built libraries/packages to the respective S3/Cloud storage."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"error-handling--logging",children:"Error Handling & Logging"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"All major operations are logged using a custom logger."}),"\n",(0,s.jsx)(i.li,{children:"Errors during installation, update, or removal are caught and logged, with failed operations retried or skipped as appropriate."}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"extensibility",children:"Extensibility"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"The service is designed to be extensible, allowing for additional storage backends, permission systems, or library sources to be integrated with minimal changes."}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-typescript",children:"// Inject and use the service in a NestJS module\n@Injectable()\nexport class SomeModule {\n  constructor(private readonly h5pLibraryManagementService: H5PLibraryManagementService) {}\n\n  async manageLibraries() {\n    await this.h5pLibraryManagementService.run();\n  }\n}\n"})}),"\n",(0,s.jsx)(i.h2,{id:"related-files",children:"Related Files"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"h5p-library-management.service.ts"}),": Main service implementation"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"h5p-library-management.config.ts"}),": Configuration interface"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"h5p-library-management.service.spec.ts"}),": Unit tests"]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://h5p.org/documentation",children:"H5P Hub Documentation"})}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://docs.nestjs.com/",children:"NestJS Documentation"})}),"\n"]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.p,{children:"For further details, see inline comments in the service source code."})]})}function h(e={}){const{wrapper:i}={...(0,l.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>t});var r=n(6540);const s={},l=r.createContext(s);function a(e){const i=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function t(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(l.Provider,{value:i},e.children)}}}]);