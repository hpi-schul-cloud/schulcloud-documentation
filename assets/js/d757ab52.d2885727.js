"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[9826],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=d(n),u=r,m=h["".concat(l,".").concat(u)]||h[u]||c[u]||i;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:r,o[1]=s;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3600:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const i={},o="How it works",s={unversionedId:"services/etherpad/How it works",id:"services/etherpad/How it works",title:"How it works",description:"Configuration",source:"@site/docs/services/etherpad/How it works.md",sourceDirName:"services/etherpad",slug:"/services/etherpad/How it works",permalink:"/docs/services/etherpad/How it works",draft:!1,editUrl:"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/services/etherpad/How it works.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Detect Dependency Cycles",permalink:"/docs/Informations/detect-dependency-cycles"},next:{title:"Local Setup",permalink:"/docs/services/etherpad/Local setup"}},l={},d=[{value:"Configuration",id:"configuration",level:2},{value:"Creating and Opening an Etherpad Element on a Column Board",id:"creating-and-opening-an-etherpad-element-on-a-column-board",level:2},{value:"Creating an Etherpad Element",id:"creating-an-etherpad-element",level:3},{value:"Interacting with the Etherpad Element",id:"interacting-with-the-etherpad-element",level:3},{value:"Grouping and Creating Etherpads",id:"grouping-and-creating-etherpads",level:3},{value:"Session Creation and Cookie Setting",id:"session-creation-and-cookie-setting",level:3},{value:"Opening the Etherpad",id:"opening-the-etherpad",level:3},{value:"Etherpad Adapter",id:"etherpad-adapter",level:2},{value:"Authentication",id:"authentication",level:2},{value:"Session managment",id:"session-managment",level:2},{value:"Etherpad Session Creation and Expiration",id:"etherpad-session-creation-and-expiration",level:3},{value:"Session Reuse",id:"session-reuse",level:3},{value:"Session Renewal",id:"session-renewal",level:3},{value:"Session Removal",id:"session-removal",level:3},{value:"Cookie Management",id:"cookie-management",level:3},{value:"Legacy Topics",id:"legacy-topics",level:3}],p={toc:d},h="wrapper";function c(e){let{components:t,...i}=e;return(0,r.kt)(h,(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-it-works"},"How it works"),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"FEATURE_ETHERPAD_ENABLED - Used to enable etherpad feature in feathers backend")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"FEATURE_COLUMN_BOARD_COLLABORATIVE_TEXT_EDITOR_ENABLED - Enables etherpad feature on column boards")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__COOKIE_EXPIRES_SECONDS - Time in seconds after which a session expires")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__COOKIE_RELEASE_THRESHOLD - Time in seconds after which a session is not returned to the user")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__API_KEY - Api key used for authentication of schulcloud server requests")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__URI - Uri of etherpad api for all calls like create, delete etc. Used as base path for api client in nest and feathers backend.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__PAD_URI - URI to etherpad client api. Used in backend in collaborative text editor and lesson to build return url. Used in legacy client to build url.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__OLD_PAD_URI - Used in feathers backend to restrict access to old etherpad urls to lesson context. Only defined in default.schema.json and not in dof-app-deploy ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__PAD_PATH - Path to etherpad client api. Used in legacy client to set path on cookie.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__NEW_DOMAIN - Etherpad Domain. Used in legacy client to validate url")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ETHERPAD__OLD_DOMAIN - Old Etherpad Domain. Used in legacy client to identify old urls in lessons and transform them to urls with new domain."))),(0,r.kt)("h2",{id:"creating-and-opening-an-etherpad-element-on-a-column-board"},"Creating and Opening an Etherpad Element on a Column Board"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Requests of etherpad creation",src:n(6376).Z,width:"1251",height:"805"})),(0,r.kt)("h3",{id:"creating-an-etherpad-element"},"Creating an Etherpad Element"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The user initiates the process by creating an Etherpad element on a column board."),(0,r.kt)("li",{parentName:"ol"},"Vue then sends a request to the board module in the Schulcloud server for a new Etherpad element."),(0,r.kt)("li",{parentName:"ol"},"The server responds by returning an Etherpad element which is then displayed on the board.")),(0,r.kt)("h3",{id:"interacting-with-the-etherpad-element"},"Interacting with the Etherpad Element"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"When the user clicks on the Etherpad element, the Vue client sends a request to the collaborative text editor module in the Schulcloud server for a new Etherpad."),(0,r.kt)("li",{parentName:"ol"},"The Schulcloud server is capable of creating Etherpads based on parent types. The parent type is further used for handling authorisation of the etherpad. Currently, the only parent type is a column board element.")),(0,r.kt)("h3",{id:"grouping-and-creating-etherpads"},"Grouping and Creating Etherpads"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The Schulcloud server first creates a group that clusters several Etherpads together. Each group shares a session and a new group is created for every column board element. This requires sending a request to the Etherpad server."),(0,r.kt)("li",{parentName:"ol"},"Once the group is created, the server can send a request to create an Etherpad within that group.")),(0,r.kt)("h3",{id:"session-creation-and-cookie-setting"},"Session Creation and Cookie Setting"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"For session creation, the server first needs to request an Etherpad author and then the session for that author."),(0,r.kt)("li",{parentName:"ol"},"With that session, the server can set a session cookie in the client's browser and return the Etherpad URL to Vue.")),(0,r.kt)("h3",{id:"opening-the-etherpad"},"Opening the Etherpad"),(0,r.kt)("p",null,"In the final step, Vue opens the Etherpad URL in a new browser tab, enabling the user to interact directly with the Etherpad. It's important to note that the Etherpad client interface displayed to the user is served by the Etherpad server, and as such, it is not a part of our own codebase."),(0,r.kt)("h2",{id:"etherpad-adapter"},"Etherpad Adapter"),(0,r.kt)("p",null,"For the communication with the Etherpad server, the Schulcloud server uses an adapter. This adapter is responsible for handling all requests to the Etherpad server and ensuring that the correct data is sent and received. This adapter uses a client that is generated by open api generator. Client generation can be triggered with ",(0,r.kt)("inlineCode",{parentName:"p"},"generate-client:etherpad")," and should be executed after update of etherpad server."),(0,r.kt)("h2",{id:"authentication"},"Authentication"),(0,r.kt)("p",null,"The authentication process in our system works via a token. This token is sent with each request as a parameter to ensure secure communication."),(0,r.kt)("p",null,"The token is defined by the ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_API_KEY")," environment variable. This variable holds the key used for authentication, ensuring that only authorized requests are processed."),(0,r.kt)("p",null,"In the Schulcloud server, this API key is passed to the etherpad adapter on its initialization in the collaborative text editor module."),(0,r.kt)("h2",{id:"session-managment"},"Session managment"),(0,r.kt)("h3",{id:"etherpad-session-creation-and-expiration"},"Etherpad Session Creation and Expiration"),(0,r.kt)("p",null,"Each interaction with an Etherpad element initiates the creation of a new session. The lifespan of this session is determined by the ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE__EXPIRES_SECONDS"),' environment variable. Once this time period elapses, the user loses access to the pad. This loss of access is indicated by the display of a non-translated English message: "You do not have permission to access this pad." However, even after the session expires, users can still view the pad content as long as they do not interact with it.'),(0,r.kt)("h3",{id:"session-reuse"},"Session Reuse"),(0,r.kt)("p",null,"Upon subsequent interactions with the Etherpad element, an existing session for that element may be reused. Whether an old session is reused or a new one is created depends on the environment variable settings. The ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE_RELEASE_THRESHOLD")," variable determines the remaining validity period of a session for it to be delivered to the user. In the current production environment, both ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE_RELEASE_THRESHOLD")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE__EXPIRES_SECONDS")," are set to the same value of 2 hours. This configuration results in the creation of a new session for each interaction with an Etherpad element."),(0,r.kt)("h3",{id:"session-renewal"},"Session Renewal"),(0,r.kt)("p",null,"Currently there is no automatic session renewal upon interaction. Etherpad provides the ",(0,r.kt)("inlineCode",{parentName:"p"},"COOKIE_SESSION_REFRESH_INTERVAL")," configuration variable, which specifies the time period after which a user's session is automatically renewed in an open tab. However, this variable is currently unset, and the default value of 1 day has no effect because it exceeds the ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE__EXPIRES_SECONDS")," value. Therefore, sessions are not automatically renewed."),(0,r.kt)("h3",{id:"session-removal"},"Session Removal"),(0,r.kt)("p",null,"When a user logs out of Schulcloud, all sessions are terminated, and the user loses access to the pads upon interaction. However, Etherpad sessions are not automatically removed upon user auto-logout in Schulcloud. As long as ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE__EXPIRES_SECONDS")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"JWT_TIMEOUT_SECONDS")," are set to the same value, all sessions should theoretically become invalid after auto-logout."),(0,r.kt)("h3",{id:"cookie-management"},"Cookie Management"),(0,r.kt)("p",null,"A cookie named sessionID is stored for each session. These cookies are not programmatically removed after the ",(0,r.kt)("inlineCode",{parentName:"p"},"ETHERPAD_COOKIE__EXPIRES_SECONDS")," period or upon Schulcloud logout."),(0,r.kt)("h3",{id:"legacy-topics"},"Legacy Topics"),(0,r.kt)("p",null,"Same session behavior also applies to legacy code. Env vars are used by both implementations."),(0,r.kt)("p",null,"In contrast to the nest code in legacy code a session is created for every course and stored as a cookie for every etherpad."))}c.isMDXComponent=!0},6376:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/how_it_works-5ce97ed02f4c54237f64f270244a59f0.png"}}]);