"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[6552],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>g});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),d=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=d(a),c=i,g=m["".concat(s,".").concat(c)]||m[c]||p[c]||r;return a?n.createElement(g,o(o({ref:t},u),{},{components:a})):n.createElement(g,o({ref:t},u))}));function g(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[m]="string"==typeof e?e:i,o[1]=l;for(var d=2;d<r;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},476:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var n=a(7462),i=(a(7294),a(3905));const r={},o=void 0,l={unversionedId:"backend/Migrations",id:"backend/Migrations",title:"Migrations",description:"Migrations for server database",source:"@site/docs/backend/Migrations.md",sourceDirName:"backend",slug:"/backend/Migrations",permalink:"/docs/backend/Migrations",draft:!1,editUrl:"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/backend/Migrations.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"VSCode",permalink:"/docs/backend/Development/vs-code"},next:{title:"Software Architecture",permalink:"/docs/backend/architecture"}},s={},d=[{value:"Migrations for server database",id:"migrations-for-server-database",level:2},{value:"Create a new migration",id:"create-a-new-migration",level:3},{value:"Apply migrations",id:"apply-migrations",level:3},{value:"Undo migration",id:"undo-migration",level:3},{value:"Notes about setup",id:"notes-about-setup",level:3},{value:"Test migration",id:"test-migration",level:2},{value:"Committing a migration",id:"committing-a-migration",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"General",id:"general",level:3},{value:"Performance",id:"performance",level:3},{value:"Error Handling/Logging",id:"error-handlinglogging",level:3},{value:"Debugging",id:"debugging",level:3},{value:"Caveats",id:"caveats",level:3},{value:"using entity manager",id:"using-entity-manager",level:4},{value:"Outdated Migrations",id:"outdated-migrations",level:4}],u={toc:d},m="wrapper";function p(e){let{components:t,...a}=e;return(0,i.kt)(m,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"migrations-for-server-database"},"Migrations for server database"),(0,i.kt)("p",null,"Executing a migration means to change the database structure by updating a model and/or updating user data to the target model."),(0,i.kt)("p",null,"The documentation about the migration concept and tool on npm can be found at ",(0,i.kt)("a",{parentName:"p",href:"https://mikro-orm.io/docs/migrations"},"MikroORM documentation"),". Please be aware of current mikro-orm version."),(0,i.kt)("h3",{id:"create-a-new-migration"},"Create a new migration"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"npm run migration:create")," will create a new migration file in ",(0,i.kt)("inlineCode",{parentName:"p"},"./apps/server/src/migrations/mikro-orm")," folder."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Please log all database changes (before and after state of documents or at least all modified document id's)")),(0,i.kt)("h3",{id:"apply-migrations"},"Apply migrations"),(0,i.kt)("p",null,"To run migrations you can use the command below:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run migration:up")," will run the compiled js file. This command is safer, and used in production."),(0,i.kt)("li",{parentName:"ul"},"You can also apply any specific migration. Look at the documentation for more details.")),(0,i.kt)("h3",{id:"undo-migration"},"Undo migration"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"npm run migration:down")," will undo the last migration that has been applied."),(0,i.kt)("h3",{id:"notes-about-setup"},"Notes about setup"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Migrations are stored in the database ",(0,i.kt)("inlineCode",{parentName:"li"},"migrations")," collection."),(0,i.kt)("li",{parentName:"ul"},"There is no status for a migration. Once the migration has been applied, a record is added in the database."),(0,i.kt)("li",{parentName:"ul"},"The command will compare migration files and database records to know which migrations to apply."),(0,i.kt)("li",{parentName:"ul"},"Migration configuration is locates in ",(0,i.kt)("inlineCode",{parentName:"li"},"./apps/server/src/mikro-orm.config.ts")," file. MikroORM uses the config file to connect to the database and to find the migrations folder.")),(0,i.kt)("h2",{id:"test-migration"},"Test migration"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Use the following command to check for pending migrations:"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run migration:pending")," to run the compiled js file. The second command is safer, and used in CI and should be used in K8 clusters."),(0,i.kt)("li",{parentName:"ul"},"The CI job ",(0,i.kt)("inlineCode",{parentName:"li"},"./.github/workflows/migrations.yml")," will check that the migrations are already included in the seed data. If not, it will fail. This is to ensure that the seed data is always up to date with the migrations.")),(0,i.kt)("h2",{id:"committing-a-migration"},"Committing a migration"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run setup:db:seed")," - to update the whole database\nor use ",(0,i.kt)("inlineCode",{parentName:"li"},"npm run nest:start:console -- database --help")," to see how to import/export single collection"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run migration:up")," - to apply the migration update to the migrations collection"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"migration:persisted")," (copies the collections to folder backup/DATE, move the changed files of this folder to backup/setup and commit the updated files)\nor use ",(0,i.kt)("inlineCode",{parentName:"li"},"npm run nest:start:console -- database export --collection <collection> --override")," to override seed data directly.\nThe updated collections that where modified by your migration are added to backup/setup folder.")),(0,i.kt)("p",null,"Commit the changes:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"git add .")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},'git commit -m "migration: <migration name>"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"git push")),(0,i.kt)("li",{parentName:"ul"},"Test that the migration was applied ",(0,i.kt)("inlineCode",{parentName:"li"},"npm run migration:pending")," should return nothing")),(0,i.kt)("h2",{id:"best-practices"},"Best Practices"),(0,i.kt)("h3",{id:"general"},"General"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Consider if a migration is the right tool for this job"),(0,i.kt)("li",{parentName:"ul"},"Recurring tasks are better placed in a script/console"),(0,i.kt)("li",{parentName:"ul"},"Test the migration well"),(0,i.kt)("li",{parentName:"ul"},"If a migration should be deleted, do not delete the migration file itself, but remove the content of the up and down method and log a skip message"),(0,i.kt)("li",{parentName:"ul"},"Consider if the migration can be written to be idempotent (can be executed multiple times without problems)")),(0,i.kt)("h3",{id:"performance"},"Performance"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Think about the size of the collection. On production, large collections with a lot of data, might take a long time to migrate or can lead to time-out errors."),(0,i.kt)("li",{parentName:"ul"},"Use methods already provided by mongo for bulk operations (e.g. updateMany, deleteMany etc.). But think about handle items separately with extra logging and separate error handling in that case."),(0,i.kt)("li",{parentName:"ul"},"Load the data chunkwise and process them asynchronously"),(0,i.kt)("li",{parentName:"ul"},"Query the data with ",(0,i.kt)("inlineCode",{parentName:"li"},"skip")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"limit")," (example migration) or use async iterators with mongoose queries (blog post, example migration)."),(0,i.kt)("li",{parentName:"ul"},"Migrations should in general not be executed in parallel (on multiple pods)."),(0,i.kt)("li",{parentName:"ul"},"Use for loops with synchronous execution and logging. Avoid subtasks awaiting Promise.all()."),(0,i.kt)("li",{parentName:"ul"},"As long as data is loaded in chunks or cursors, performance should not be an issue.")),(0,i.kt)("h3",{id:"error-handlinglogging"},"Error Handling/Logging"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If a migration throws an error, the subsequent migrations are not executed."),(0,i.kt)("li",{parentName:"ul"},"Catch errors if the errors can be handled by the next release, so it will not become a release blocker."),(0,i.kt)("li",{parentName:"ul"},"Log start and end of a migration (so that we know which migration currently is running)."),(0,i.kt)("li",{parentName:"ul"},"Log intermediate results for long-running migration (so that we know if it is still running)."),(0,i.kt)("li",{parentName:"ul"},"Use log level ",(0,i.kt)("inlineCode",{parentName:"li"},"alert")," or above, so the output can be seen on production."),(0,i.kt)("li",{parentName:"ul"},"Logging might be difficult to fix, instead it might be helpful to keep before-states in a separate collection")),(0,i.kt)("h3",{id:"debugging"},"Debugging"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Use env ",(0,i.kt)("inlineCode",{parentName:"li"},"MIKRO_ORM_CLI_VERBOSE=1")),(0,i.kt)("li",{parentName:"ul"},"Mikro-orm debug info can be added in config file",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"debug: true")," will log all queries"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"logger: console.log")," will log all queries"))),(0,i.kt)("li",{parentName:"ul"},"Debug breakpoints can be added in migration files"),(0,i.kt)("li",{parentName:"ul"},"Run with typical debug options for your IDE (e.g. in ",(0,i.kt)("a",{parentName:"li",href:"https://blog.jetbrains.com/webstorm/2018/01/how-to-debug-with-webstorm/#prepare_for_debugging_create_a_run_debug_configuration"},"Webstorm create a Run/Debug")," npm command and run it with debug options)")),(0,i.kt)("h3",{id:"caveats"},"Caveats"),(0,i.kt)("h4",{id:"using-entity-manager"},"using entity manager"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"According to documentation, the entity manager should not be used in migrations. Instead, the migration must use the ",(0,i.kt)("inlineCode",{parentName:"li"},"mongoClient")," to access the database.")),(0,i.kt)("h4",{id:"outdated-migrations"},"Outdated Migrations"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"By their nature, migrations become outdated as the database model changes. You are never expected to update migrations due to any changes in the code that are made."),(0,i.kt)("li",{parentName:"ul"},"If needed, for example because the migration shows errors due to a code (model) changes, migrations can be deleted, since they will still be accessible in the git history.")))}p.isMDXComponent=!0}}]);