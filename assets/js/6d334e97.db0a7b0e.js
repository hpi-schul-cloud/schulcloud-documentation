"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[654],{3045:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"backend/Configuration","title":"Configuration state and flows","description":"Short hints","source":"@site/docs/backend/Configuration.md","sourceDirName":"backend","slug":"/backend/Configuration","permalink":"/docs/backend/Configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/backend/Configuration.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Using the API of a Mikroservice","permalink":"/docs/backend/Coding-Guidelines/using-mikroservice-apis"},"next":{"title":"Git","permalink":"/docs/backend/Development/git"}}');var o=t(4848),i=t(8453);const a={},r="Configuration state and flows",l={},c=[{value:"Short hints",id:"short-hints",level:2},{value:"History and legacy tech stack",id:"history-and-legacy-tech-stack",level:2},{value:"FeatherJS and Express",id:"featherjs-and-express",level:3},{value:"Current and NestJS solutions",id:"current-and-nestjs-solutions",level:2},{value:"@hpi-schul-cloud/commons",id:"hpi-schul-cloudcommons",level:3},{value:"./config/global.js (deprecated)",id:"configglobaljs-deprecated",level:3},{value:"./config/production.js (deprecated)",id:"configproductionjs-deprecated",level:3},{value:"./config/default.schema.json",id:"configdefaultschemajson",level:3},{value:"./config/default.json",id:"configdefaultjson",level:3},{value:"./config/development.json",id:"configdevelopmentjson",level:3},{value:"./config/test.json",id:"configtestjson",level:3},{value:"Auto deployment (overriding and setting additional values)",id:"auto-deployment-overriding-and-setting-additional-values",level:3},{value:"Nestjs configuration module",id:"nestjs-configuration-module",level:3},{value:"Setup configuration interfaces",id:"setup-configuration-interfaces",level:4},{value:"Special cases in nestjs",id:"special-cases-in-nestjs",level:3},{value:"Passing configuration to vue client",id:"passing-configuration-to-vue-client",level:2},{value:"Desired changes in future",id:"desired-changes-in-future",level:2},{value:"Local setups",id:"local-setups",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"configuration-state-and-flows",children:"Configuration state and flows"})}),"\n",(0,o.jsx)(n.h2,{id:"short-hints",children:"Short hints"}),"\n",(0,o.jsx)(n.p,{children:"Every environment variable that is used or refactored, should be added to ./config/default.schema.json.."}),"\n",(0,o.jsx)(n.p,{children:"We want to avoid any process.env.XXX call inside of the code."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"It is a syncron call that stops the node process for a short moment and other async tasks can not be executed.\nIt is not documentated in a single place, or has a description to understand for what it is used.\nAny validation and used default value is set on the called placed and is hard to detected by deploying and reuse on other places."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"history-and-legacy-tech-stack",children:"History and legacy tech stack"}),"\n",(0,o.jsx)(n.h3,{id:"featherjs-and-express",children:"FeatherJS and Express"}),"\n",(0,o.jsxs)(n.p,{children:["Our legacy stack uses featherJS ",(0,o.jsx)(n.a,{href:"https://docs.feathersjs.com/api/configuration.html",children:"https://docs.feathersjs.com/api/configuration.html"}),".\nIt is embedded in the express application."]}),"\n",(0,o.jsx)(n.p,{children:"Express and featherJS use the environment variable as the default behavior.\nNODE_ENV=production|test|default\nIt is extended over featherJS and directly matched to\n./config/\ndefault.json\ntest.json\nprodcution.json (deprecated)\ndevelopment.json (matching added by us)"}),"\n",(0,o.jsx)(n.p,{children:"Default is (like it is expected) as default and is overwritten by added environment variables from test.json, or production.json."}),"\n",(0,o.jsx)(n.h2,{id:"current-and-nestjs-solutions",children:"Current and NestJS solutions"}),"\n",(0,o.jsx)(n.h3,{id:"hpi-schul-cloudcommons",children:"@hpi-schul-cloud/commons"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    const { Configuration } = require('@hpi-schul-cloud/commons');\n\n    const url = Configuration.get('FILES_STORAGE__SERVICE_BASE_URL');\n"})}),"\n",(0,o.jsx)(n.p,{children:"It is used for parsing any environment value that is added in ./config/default.schema.json.\nIt is overridden with values in default.json.\nThe default.json is also overridden by development.json (NODE_ENV==='default'), or test.json. (NODE_ENV==='test')."}),"\n",(0,o.jsx)(n.p,{children:"For legacy featherJS stack, or legacy client it is the only solution that should be used.\nFor newer nestjs stack we use it for parsing values in the right order, but map it to the nestjs based solution."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Look to the topic nestjs in this file for more information."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The vue client we pass this values over an api endpoint."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:'Look to the topic "Passing configuration to vue client" in this file'}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    let configBefore;\n\n    before(() => {\n        configBefore = Configuration.toObject({ plainSecrets: true });\n\n        Configuration.set('ENVIRONMENT_NAME', 'fake.value');\n    });\n\n    after(async () => {\n        Configuration.reset(configBefore);\n    });\n\n"})}),"\n",(0,o.jsx)(n.h3,{id:"configglobaljs-deprecated",children:"./config/global.js (deprecated)"}),"\n",(0,o.jsx)(n.p,{children:"To collect and cleanup all existing process.env.XXX calls in code, it exists a step, where all environments variables are moved to global.js file.\nThis should not be used anymore and cleaned up."}),"\n",(0,o.jsx)(n.p,{children:"Feel free to move variables to default.schema.json."}),"\n",(0,o.jsx)(n.h3,{id:"configproductionjs-deprecated",children:"./config/production.js (deprecated)"}),"\n",(0,o.jsx)(n.p,{children:"This config values should not be used anymore."}),"\n",(0,o.jsx)(n.p,{children:"The default.schema.json and default.json represent the default values that should be set in all production systems.\nAll other production values are added over autodeployment configurations."}),"\n",(0,o.jsx)(n.h3,{id:"configdefaultschemajson",children:"./config/default.schema.json"}),"\n",(0,o.jsx)(n.p,{children:"We want to move any environment variable to this file for now."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Please add a discription and if possible default values to it.\nAny default values that are set on this files should be for production systems. They can be overridden with autodeployment configurations."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"It make sense to cluster variables with same context.\nDepending on the context, the motivation for clustering variables can vary, please see current usage for further examples.\nFor this cases you can add embedded objects. By passing a value to embedded objects, you can write MY_SCOPE_NAME__MY_VARIABLEN_NAME.\nThe scope name and value is splitted by double underscore ( _ ).\nDefaults values for embedded objects do not work well. For this we let the default.json stay alive."}),"\n",(0,o.jsx)(n.h3,{id:"configdefaultjson",children:"./config/default.json"}),"\n",(0,o.jsxs)(n.p,{children:["It stays alive and is only used for ",(0,o.jsx)(n.em,{children:"default values of embedded objects"})," in default.schema.json\nThe values should be the same as in default.schema.json and are added as default values. (means production values)"]}),"\n",(0,o.jsx)(n.h3,{id:"configdevelopmentjson",children:"./config/development.json"}),"\n",(0,o.jsx)(n.p,{children:"This file overrides default.json and default.schema.json values.\nIt is used for local development.\nFor example it increases the timeouts to enable us to debug stuff."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:'Please look to "local setups" topic on this page, if you only want to add your personal settings.'}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"configtestjson",children:"./config/test.json"}),"\n",(0,o.jsx)(n.p,{children:"This file overrides default.json and default.schema.json values.\nIt is used for test executions. (NODE_ENV==='test')\nFor example to reduce log outputs."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Please change carefully. It effects all tests in this repository. In best case avoid using it."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"For test we can also use injections of the nestjs configuration module, or service to set values for a special test."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Please look to featherJS test examples or nestjs test examples in this file for configurations that should only effect single tests."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"auto-deployment-overriding-and-setting-additional-values",children:"Auto deployment (overriding and setting additional values)"}),"\n",(0,o.jsx)(n.p,{children:"We have 2 sources that can fullfill and add environments.\nOne is our auto deployment repository that can set environment values directly over config.jsons.\nThe other source fetches secrets for .dev systems from gitHub, or 1password for productions."}),"\n",(0,o.jsx)(n.p,{children:"We only add values to it if we need them. If we want the default values from default.schema.json,\non all production like systems (dev, ref, production), they shouldn't be added to configurations in autodeployment."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Over this way we can reduce the total amount of environment values in production pods."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://github.com/hpi-schul-cloud/dof_app_deploy/blob/main/ansible/group_vars/all/config.yml",children:"https://github.com/hpi-schul-cloud/dof_app_deploy/blob/main/ansible/group_vars/all/config.yml"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"For documentation on how it is works, plase look at our confluence. No github documentation exists atm."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"nestjs-configuration-module",children:"Nestjs configuration module"}),"\n",(0,o.jsx)(n.h4,{id:"setup-configuration-interfaces",children:"Setup configuration interfaces"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://docs.nestjs.com/techniques/configuration",children:"https://docs.nestjs.com/techniques/configuration"}),"\n",(0,o.jsx)(n.a,{href:"https://docs.nestjs.com/techniques/configuration",children:"https://docs.nestjs.com/techniques/configuration"})]}),"\n",(0,o.jsx)(n.p,{children:"We implemented a solution that is based on nestjs and combined it with the parsing from the @hpi-schul-cloud/commons of the existing config files.\nIn future we want to replace it with a nestjs only solution."}),"\n",(0,o.jsxs)(n.p,{children:["Any module that needs configuration, can define his need by creating a interface file with the schema I",(0,o.jsx)(n.em,{children:"MY_NAME"}),"Config.\nIn first step we add this interfaces directly to an app config file which extends ...,I",(0,o.jsx)(n.em,{children:"MY_NAME"}),"Config,...,.. .\nThe combined Iconfig interface can be used to initilized the nestjs configuration module.\nThe nestjs configuration module is defined globally in the hole app and can be used over injections."]}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"We force it this way, so that modules can be defined by their needs.\nWe only have a single point, where all envirements are added to our application.\nWe can easily replace this solution with a nestjs parser instead, of Configuration from @hpi-schul-cloud/commons in future."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This code shows a minimal flow."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    // needed configuration for a module\n    export interface UserConfig {\n        AVAILABLE_LANGUAGES: string[];\n    }\n\n    // server.config.ts\n    export interface ServerConfig extends ICoreModuleConfig, UserConfig, IFilesStorageClientConfig {\n        NODE_ENV: string;\n    }\n\n    // server.module.ts\n    import { Module } from '@nestjs/common';\n    import { ConfigModule } from '@nestjs/config';\n    import serverConfig from './server.config';\n    import { createConfigModuleOptions } from '@shared/common/config-module-options';\n\n\n    const serverModules = [\n        ConfigModule.forRoot(createConfigModuleOptions(serverConfig))\n    ]\n\n    @Module({\n        imports: [...serverModules],\n    })\n    export class ServerModule {}\n\n    //use via injections\n    import { ConfigService } from '@nestjs/config';\n    import { UserConfig } from '../interfaces';\n\n    constructor(private readonly configService: ConfigService<UserConfig, true>){}\n\n    this.configService.get<string[]>('AVAILABLE_LANGUAGES');\n\n    //use in modules construction\n    import { ConfigService } from '@nestjs/config';\n    import { Configuration, FileApi } from './filesStorageApi/v3';\n\n    @Module({\n    providers: [\n        {\n            provide: 'Module',\n            useFactory: (configService: ConfigService<IFilesStorageClientConfig, true>) => {\n                const timeout = configService.get<number>('INCOMING_REQUEST_TIMEOUT');\n\n                const options = new Configuration({\n                    baseOptions: { timeout },\n                });\n\n                return new FileApi(options, baseUrl + apiUri);\n            },\n            inject: [ConfigService],\n        })\n    export class Module {}\n\n"})}),"\n",(0,o.jsx)(n.p,{children:"Mocking in unit and integration tests."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    import { Test, TestingModule } from '@nestjs/testing';\n    import { createMock, DeepMocked } from '@golevelup/ts-jest';\n\n    describe('XXX', () => {\n        let config: DeepMocked<ConfigService>;\n        let app: INestApplication;\n\n        beforeAll(async () => {\n            const module: TestingModule = await Test.createTestingModule({\n                providers: [\n                    {\n                        provide: ConfigService,\n                        useValue: createMock<ConfigService>(),\n                    },\n                ],\n            }).compile();\n\n            config = module.get(ConfigService);\n            app = module.createNestApplication();\n        });\n\n        const setup = () => {\n            config.get.mockReturnValueOnce(['value']);\n        }\n\n        it('XXX', () => {\n            setup();\n        })\n\n        afterAll(async () => {\n            config.get.mockRestore();\n            await app.close();\n        })\n\n    });\n\n"})}),"\n",(0,o.jsx)(n.p,{children:"Mocking in api tests."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    import { ServerTestModule } from '@modules/server/server.app.module';\n    import { serverConfig } from '@modules/server/server.config';\n    import { TestConfigHelper } from '@testing/test-config.helper';\n\n    describe('...Controller (API)', () => {\n        let app: INestApplication;\n        let em: EntityManager;\n        let testApiClient: TestApiClient;\n        let testConfigHelper: TestConfigHelper<ServerConfig>;\n\n        beforeAll(async () => {\n            const module: TestingModule = await Test.createTestingModule({\n                imports: [ServerTestModule],\n            }).compile();\n\n            app = module.createNestApplication();\n\t\t    await app.init();\n            em = app.get(EntityManager);\n\t\t    testApiClient = new TestApiClient(app, '...path...');\n\n            const config = serverConfig();\n\t\t    testConfigHelper = new TestConfigHelper(config);\n        });\n\n        afterEach(() => {\n\t\t    testConfigHelper.reset();\n\t    });\n\n        describe('PATCH /:id', () => {\n            describe('when feature X is activated', () => {\n                const setup = async () => { \n                    testConfigHelper.set('FEATURE_X', true);\n                };\n\n                it('should ...', () => {\n                    await setup();\n                });\n\n                it('should ...', () => {\n                   await setup();\n                });\n\n                it('should ...', () => {\n                   await setup();\n                });\n            });\n        });\n    });\n"})}),"\n",(0,o.jsx)(n.h3,{id:"special-cases-in-nestjs",children:"Special cases in nestjs"}),"\n",(0,o.jsx)(n.p,{children:"If we want to use values in decorators, we can not use the nestjs configuration module.\nThe parsing of decorators in files starts first and after it the injections are solved."}),"\n",(0,o.jsx)(n.p,{children:"It is possible to import the config file of the application directly and use the values."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"    import serverConfig from '@modules/server/server.config';\n\n    @RequestTimeout(serverConfig().INCOMING_REQUEST_TIMEOUT_COPY_API)\n"})}),"\n",(0,o.jsx)(n.h2,{id:"passing-configuration-to-vue-client",children:"Passing configuration to vue client"}),"\n",(0,o.jsx)(n.p,{children:"It exists an endpoint that exposes environment values.\nThis values are used by the vue client.\nThe solution is the only existing way how environments should be passed to the new vue client."}),"\n",(0,o.jsx)(n.p,{children:"Please be careful! Secrets should be never exposed!\nThey are readable in browser and request response."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://github.com/hpi-schul-cloud/schulcloud-server/blob/main/apps/server/src/modules/server/api/server-config.controller.ts",children:"https://github.com/hpi-schul-cloud/schulcloud-server/blob/main/apps/server/src/modules/server/api/server-config.controller.ts"})}),"\n",(0,o.jsxs)(n.p,{children:["http://{{HOST}}:{{PORT}}/api/v3/config/public",(0,o.jsx)(n.br,{}),"\n","http://{{HOST}}:{{PORT}}/api/v3/files/config/public"]}),"\n",(0,o.jsx)(n.h2,{id:"desired-changes-in-future",children:"Desired changes in future"}),"\n",(0,o.jsx)(n.p,{children:"We want to remove the different config files and the Configuration from @hpi-schul-cloud/commons package.\nWe want to use the nestjs solutions over parsing configuration values for different states.\nThis results in a new format for the default.schema.json file."}),"\n",(0,o.jsx)(n.p,{children:"We also want to put more environment values to database, to enable us to switching it without redeploys over our dashboard."}),"\n",(0,o.jsx)(n.h2,{id:"local-setups",children:"Local setups"}),"\n",(0,o.jsx)(n.p,{children:"You can use the .env convention to set settings that only work for you locally.\nFor temporary checks you can add environments to your terminal based on the solution of your IOS.\nYou can also add environments for debugging, or if you run your applications over .vscode/lunch.json with:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'    "env": {\n        "NODE_ENV": "test"\n    }\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(6540);const o={},i=s.createContext(o);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);