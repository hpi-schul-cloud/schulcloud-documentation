"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[187],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>f});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(n),h=r,f=u["".concat(s,".").concat(h)]||u[h]||p[h]||a;return n?o.createElement(f,i(i({ref:t},d),{},{components:n})):o.createElement(f,i({ref:t},d))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},3054:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=n(7462),r=(n(7294),n(3905));const a={},i="Module Description - files-storage",l={unversionedId:"services/files-storage/How it works",id:"services/files-storage/How it works",title:"Module Description - files-storage",description:"Summary",source:"@site/docs/services/files-storage/How it works.md",sourceDirName:"services/files-storage",slug:"/services/files-storage/How it works",permalink:"/docs/services/files-storage/How it works",draft:!1,editUrl:"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/services/files-storage/How it works.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Files Storage",permalink:"/docs/category/files-storage"},next:{title:"S3 commands",permalink:"/docs/services/files-storage/S3 commands"}},s={},c=[{value:"Summary",id:"summary",level:2},{value:"Goals and Ideas",id:"goals-and-ideas",level:2},{value:"Stand Alone Service",id:"stand-alone-service",level:3},{value:"Parent Logic",id:"parent-logic",level:3},{value:"S3 Structure",id:"s3-structure",level:3},{value:"Deleting Files",id:"deleting-files",level:3},{value:"Internal and External App and Service Interface",id:"internal-and-external-app-and-service-interface",level:3},{value:"Dependencies",id:"dependencies",level:2},{value:"Grafana",id:"grafana",level:3},{value:"DB",id:"db",level:3},{value:"Storage",id:"storage",level:3},{value:"Authorization Module",id:"authorization-module",level:3},{value:"Authentication Interceptors",id:"authentication-interceptors",level:3},{value:"ToDos",id:"todos",level:2}],d={toc:c},u="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"module-description---files-storage"},"Module Description - files-storage"),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"This module is a stand alone files service.\nThe service handles the binary files and the files meta data.\nIt provides upload and download streams."),(0,r.kt)("p",null,"The Service is used for deeper and individual authorisation contexts for files."),(0,r.kt)("p",null,"The module follows the generell structure:\nS3 > Client > Service\nDB > ORM > DataRecord > Repo > Domain Object > Service > ..\n..Service > Uc > API Controller (external communication)\n..Service > RMQP Consumer Controller (internal communication)"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Please note that Uc (Usecase) holds the authorisation and the consumer uses the service directly.\n(Avoid internal double authorisation)")),(0,r.kt)("h2",{id:"goals-and-ideas"},"Goals and Ideas"),(0,r.kt)("h3",{id:"stand-alone-service"},"Stand Alone Service"),(0,r.kt)("p",null,"Should work as stand alone service.\nIt does not know anything about the use cases it is used for.\nIt exists no real DB reference on any other place. No types, or interfaces are exposed.\nWe avoid dependency to other modules, except the ones in dependecies. (see: ## Dependencies)"),(0,r.kt)("h3",{id:"parent-logic"},"Parent Logic"),(0,r.kt)("p",null,"Any file must be placed in a scope. It is called parent (type).\nMultiple files can be added to one parent.\nThe parent is used for the authorisation.\nThe authorisation service must match and handle this types."),(0,r.kt)("h3",{id:"s3-structure"},"S3 Structure"),(0,r.kt)("p",null,"The service is connected to exactly one S3 storage bucket.\nInside the bucket it can be defined store locations to collect or aggregate informations.\nCurrently the instance it self and each school has store locations.\nThey are referenced over IDs as string, to keep the service stand alone.\nThis allows us to get total size of files and needed space for one school.\nAny school folder is created on demand."),(0,r.kt)("p",null,"Any file must be located in a school folder and referenced to a parent. (see: ### Parent Logic)"),(0,r.kt)("h3",{id:"deleting-files"},"Deleting Files"),(0,r.kt)("p",null,"Currently a file is marked for deletion and finally removed after 7 days.\nIn s3 the marked file is moved to a ./trash folder.\nThe trash folder contains also sub folders for the schools."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"./trash/schoolId/fileRecordId")),(0,r.kt)("h3",{id:"internal-and-external-app-and-service-interface"},"Internal and External App and Service Interface"),(0,r.kt)("p",null,"For internal communication we use a queue based solution instead of http.\nThe pods with queue (amqp.module) and with https controller (api.module) can be started seperatly."),(0,r.kt)("p",null,"For queue based solution we use rabbitMQ AMQP."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"https://www.rabbitmq.com/tutorials/amqp-concepts.html"},"https://www.rabbitmq.com/tutorials/amqp-concepts.html"),"\nWe only have a consumer in controller, but no producer.\nThe files service uses the rabbitMQ modul and solves the mapping to the exchange types.")),(0,r.kt)("p",null,"The api controller is documented over swagger and must support open api.\nIt is used for the openAPI generation in client."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you want to communicate with the files services from core backend, please use the files-storage-client module.")),(0,r.kt)("h2",{id:"dependencies"},"Dependencies"),(0,r.kt)("h3",{id:"grafana"},"Grafana"),(0,r.kt)("p",null,"This is not a direct dependency.\nBut we use grafana to create metrics about the service and our storage.\nThe storage structure supports the metrics creation at school and instance level."),(0,r.kt)("h3",{id:"db"},"DB"),(0,r.kt)("p",null,"We use a mongoDB with a ORM (mikroORM) to store the files meta data and the contexts.\nIt uses only one data table / collection that is called filerecords."),(0,r.kt)("h3",{id:"storage"},"Storage"),(0,r.kt)("p",null,"As storage we use a generell S3 with a the standard package for the client.\nThe package for the S3 client is wrapped in an own client interface that can be used for the communication."),(0,r.kt)("p",null,"folder structure in S3"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"schoolId/fileRecordId\n.trash/schoolId/fileRecordId (see: ## Goals and Ideas > ### Deleting Files)")),(0,r.kt)("h3",{id:"authorization-module"},"Authorization Module"),(0,r.kt)("p",null,"The authorisation is solved by parents.\nTherefore it is required that the parent types must be known to the authentication service.\nOnly the reference authorisation works."),(0,r.kt)("p",null,"It is possible to write an own authorisation modul and inject it, if you need it in future."),(0,r.kt)("h3",{id:"authentication-interceptors"},"Authentication Interceptors"),(0,r.kt)("p",null,"To avoid duplicated code the intercetors and logic for logging, authorisation from core folder is used.\nThis adds a transitive dependecy to the authentication module."),(0,r.kt)("h2",{id:"todos"},"ToDos"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Connecting with the deletion concept, include also the delete of a complete school folder. (not implemented for now)"),(0,r.kt)("li",{parentName:"ul"},'An admin interface that supports "system user" and "support tools" not existing for now.'),(0,r.kt)("li",{parentName:"ul"},"Domain Object and layer is not introduced")))}p.isMDXComponent=!0}}]);