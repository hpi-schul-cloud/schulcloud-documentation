"use strict";(self.webpackChunkdataport_docusaurus=self.webpackChunkdataport_docusaurus||[]).push([[831],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>u});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),p=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},s=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},k=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),d=p(n),k=a,u=d["".concat(c,".").concat(k)]||d[k]||m[k]||o;return n?r.createElement(u,l(l({ref:t},s),{},{components:n})):r.createElement(u,l({ref:t},s))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=k;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[d]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}k.displayName="MDXCreateElement"},8080:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const o={},l="ErWIn-IDM (Keycloak)",i={unversionedId:"backend/Development/keycloak",id:"backend/Development/keycloak",title:"ErWIn-IDM (Keycloak)",description:"ErWIn-IDM, namely Keycloak, will be the future Identity Management System (IDM) for the dBildungscloud. Keycloak",source:"@site/docs/backend/Development/keycloak.md",sourceDirName:"backend/Development",slug:"/backend/Development/keycloak",permalink:"/docs/backend/Development/keycloak",draft:!1,editUrl:"https://github.com/hpi-schul-cloud/hpi-schul-cloud.github.io/blob/main/docs/backend/Development/keycloak.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Git",permalink:"/docs/backend/Development/git"},next:{title:"Rocket.Chat",permalink:"/docs/backend/Development/rocket-chat"}},c={},p=[{value:"Docker",id:"docker",level:2},{value:"Setup OpenID Connect Identity Provider mock for ErWIn-IDM brokering",id:"setup-openid-connect-identity-provider-mock-for-erwin-idm-brokering",level:3},{value:"Setup OpenID Connect Identity Provider mock for ErWIn-IDM brokering with LDAP provisioning",id:"setup-openid-connect-identity-provider-mock-for-erwin-idm-brokering-with-ldap-provisioning",level:3},{value:"Test local environment",id:"test-local-environment",level:2},{value:"Seeding Data",id:"seeding-data",level:2},{value:"Updating Seed Data",id:"updating-seed-data",level:2},{value:"NPM Commands",id:"npm-commands",level:2}],s={toc:p},d="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,r.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"erwin-idm-keycloak"},"ErWIn-IDM (Keycloak)"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"ErWIn-IDM, namely Keycloak, will be the future Identity Management System (IDM) for the dBildungscloud. Keycloak\nprovides OpenID Connect, SAML 2.0 and other identity related functionalities like SSO out of the box. It can\nalso act as identity broker or aggregate identities from third party services which can be an active directory or LDAP.")),(0,a.kt)("h2",{id:"docker"},"Docker"),(0,a.kt)("p",null,"To run Keycloak locally for development purpose use the following Bash or PowerShell command. You can log into Keycloak\nhere ",(0,a.kt)("a",{parentName:"p",href:"http://localhost:8080"},"http://localhost:8080"),". If you don't want to block your terminal, you can add the ",(0,a.kt)("inlineCode",{parentName:"p"},"-d")," option to start the container\nin the background. Execute these commands in the repository root or the data seeding will fail, and you can not log into\nKeycloak with any user."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Bash:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'docker run \\\n  --name erwinidm \\\n  -p 8080:8080 \\\n  -p 8443:8443 \\\n  -v "$PWD/backup/idm/keycloak:/tmp/realms" \\\n  ghcr.io/hpi-schul-cloud/erwin-idm/dev:latest \\\n  "&& /opt/keycloak/bin/kc.sh import --dir /tmp/realms"\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"PowerShell:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-pwsh"},'docker run `\n  --name erwinidm `\n  -p 8080:8080 `\n  -p 8443:8443 `\n  -v "$PWD/backup/idm/keycloak:/tmp/realms" `\n  ghcr.io/hpi-schul-cloud/erwin-idm/dev:latest `\n  "&& /opt/keycloak/bin/kc.sh import --dir /tmp/realms"\n')),(0,a.kt)("h3",{id:"setup-openid-connect-identity-provider-mock-for-erwin-idm-brokering"},"Setup OpenID Connect Identity Provider mock for ErWIn-IDM brokering"),(0,a.kt)("p",null,"To add ErWIn-IDM identity broker feature via OpenID Connect (OIDC) Identity Provider (IdP) mock follow the steps below. Execute these commands in the repository root."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Set env vars (or in your .env file) 'OIDCMOCK","_","_","BASE_URL' to ",(0,a.kt)("a",{parentName:"li",href:"http://%5C%3Cyour-local-ip%5C"},"http://\\<your-local-ip\\"),":4011>."),(0,a.kt)("li",{parentName:"ul"},"To make it work with the nuxt client set the env var HOST=",(0,a.kt)("a",{parentName:"li",href:"http://localhost:4000"},"http://localhost:4000")),(0,a.kt)("li",{parentName:"ul"},"re-trigger ",(0,a.kt)("inlineCode",{parentName:"li"},"npm run setup:db")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"npm run setup:idm")," to reset and apply seed data."),(0,a.kt)("li",{parentName:"ul"},"start the 'oidc-server-mock' as follows:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker run \\\n  --name oidc-server-mock \\\n  -p 4011:80 \\\n  -e ASPNETCORE_ENVIRONMENT='Development' \\\n  -e SERVER_OPTIONS_PATH='/tmp/config/server-config.json' \\\n  -e USERS_CONFIGURATION_PATH='/tmp/config/users-config.json' \\\n  -e CLIENTS_CONFIGURATION_PATH='/tmp/config/clients-config.json' \\\n  -v \"$PWD/backup/idm/oidcmock:/tmp/config\" \\\n  ghcr.io/soluto/oidc-server-mock:0.6.0\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"PowerShell:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-pwsh"},"docker run `\n  --name oidc-server-mock `\n  -p 4011:80 `\n  -e ASPNETCORE_ENVIRONMENT='Development' `\n  -e SERVER_OPTIONS_PATH='/tmp/config/server-config.json' `\n  -e USERS_CONFIGURATION_PATH='/tmp/config/users-config.json' `\n  -e CLIENTS_CONFIGURATION_PATH='/tmp/config/clients-config.json' `\n  -v \"$PWD/backup/idm/oidcmock:/tmp/config\" `\n  ghcr.io/soluto/oidc-server-mock:0.6.0\n")),(0,a.kt)("h3",{id:"setup-openid-connect-identity-provider-mock-for-erwin-idm-brokering-with-ldap-provisioning"},"Setup OpenID Connect Identity Provider mock for ErWIn-IDM brokering with LDAP provisioning"),(0,a.kt)("p",null,"The broker feature can be setup in conjunction with LDAP provisioning for local testing purpose. Therefore, run the sc-openldap-single container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker run \\\n  --name sc-openldap-single \\\n  -p 389:389 \\\n  ghcr.io/hpi-schul-cloud/sc-openldap-single:latest\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-pwsh"},"docker run `\n  --name sc-openldap-single `\n  -p 389:389 `\n  ghcr.io/hpi-schul-cloud/sc-openldap-single:latest\n")),(0,a.kt)("p",null,"The LDAP provisioning is trigger as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X POST \\\n\xa0 'http://localhost:3030/api/v1/sync?target=ldap' \\\n\xa0 --header 'Accept: */*' \\\n\xa0 --header 'X-API-KEY: example'\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-pwsh"},'Invoke-RestMethod `\n -Uri \'http://localhost:3030/api/v1/sync?target=ldap\' `\n -Method Post `\n -Headers @{ "Accept" = "*/*"; "X-API-KEY" = "example" }\n')),(0,a.kt)("p",null,"See '/tmp/config/users-config.json' for the users details."),(0,a.kt)("h2",{id:"test-local-environment"},"Test local environment"),(0,a.kt)("p",null,"You may test your local setup executing 'keycloak-identity-management.integration.spec.ts':"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-pwsh"},"npx jest apps/server/src/shared/infra/identity-management/keycloak/service/keycloak-identity-management.service.integration.spec.ts\n")),(0,a.kt)("h2",{id:"seeding-data"},"Seeding Data"),(0,a.kt)("p",null,"During container startup Keycloak will always create the Master realm with the admin user. After startup, we use the\nKeycloak-CLI to import the dBildungscloud realm, which contains some seed users, groups and permissions for development\nand testing. In the table below you can see the username and password combinations for the Keycloak login."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Username"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Password"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"keycloak"),(0,a.kt)("td",{parentName:"tr",align:"left"},"keycloak"),(0,a.kt)("td",{parentName:"tr",align:"left"},"The overall Keycloak administrator with all permissions.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"dbildungscloud"),(0,a.kt)("td",{parentName:"tr",align:"left"},"dBildungscloud"),(0,a.kt)("td",{parentName:"tr",align:"left"},"The dBildungscloud realm specific administrator.")))),(0,a.kt)("h2",{id:"updating-seed-data"},"Updating Seed Data"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Run Keycloak and make the desired changes"),(0,a.kt)("li",{parentName:"ol"},"Use ",(0,a.kt)("inlineCode",{parentName:"li"},"docker container exec -it keycloak bash")," to start a bash in the container"),(0,a.kt)("li",{parentName:"ol"},"Use the Keycloak-CLI to export all Keycloak data with ",(0,a.kt)("inlineCode",{parentName:"li"},"/opt/keycloak/bin/kc.sh export --dir /tmp/realms")),(0,a.kt)("li",{parentName:"ol"},"Save your changes with a commit"),(0,a.kt)("li",{parentName:"ol"},"If you start your container with a command from the docker section, your changes will be directly applied to the starting Keycloak container")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"IMPORTANT: During the export process there will be some errors, that's because the export process will be done on the\nsame port as the Keycloak server. This leads to Keycloak failing to start the server in import/export mode. Due to the\ntransition from WildFly to Quarkus as application server there is currently no documentation on this topic.")),(0,a.kt)("p",null,"In order to re-apply the seeding data for a running keycloak container, you may run following commands (to be executed in the repository root):"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"docker cp ./backup/idm/keycloak keycloak:/tmp/realms")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"docker exec erwinidm /opt/keycloak/bin/kc.sh import --dir /tmp/realms"))),(0,a.kt)("h2",{id:"npm-commands"},"NPM Commands"),(0,a.kt)("p",null,"A list of available NPM commands regarding Keycloak / IDM."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Command"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"setup:idm:seed"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Seeds users for development and testing purpose into the IDM")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"setup:idm:configure"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Configures identity and authentication providers and other details in the IDM")))))}m.isMDXComponent=!0}}]);